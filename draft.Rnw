\documentclass[12 pt, twoside]{article}
%\usepackage[doublespacing]{setspace}
\usepackage{graphicx, verbatim}
\usepackage[twoside, bindingoffset=5mm]{geometry}
\usepackage[font=small,labelfont=sf]{caption}
\usepackage{float}
\usepackage{subfig}
\usepackage{url}
%%TIMELINE SHIT
\usepackage{array, booktabs}
\usepackage[x11names]{xcolor}
\usepackage{colortbl}
\usepackage{caption}
\DeclareCaptionFont{blue}{\color{LightSteelBlue3}}
\newcommand{\foo}{\color{LightSteelBlue3}\makebox[0pt]{\textbullet}\hskip-0.5pt\vrule width 1pt\hspace{\labelsep}}
%%END

%BLANK SPACE BABY
\usepackage{afterpage}

\newcommand\blankpage{%
    \null
    \thispagestyle{empty}%
    \addtocounter{page}{-1}%
    \newpage}
%End

\setlength{\textwidth}{7in} 
\setlength{\textheight}{9in}
\setlength{\oddsidemargin}{0in} 
\setlength{\evensidemargin}{0in}
\setlength{\topmargin}{-1.5cm}
\overfullrule=2cm
\usepackage{titlesec}
\usepackage[linktoc=all]{hyperref} %TOC Links
\hypersetup{colorlinks, citecolor=black, filecolor=black, linkcolor=black,urlcolor=black}
\usepackage[citestyle=verbose,bibstyle=numeric,sorting=ynt,backend=biber]{biblatex}
\usepackage[toc,page]{appendix}
\addbibresource{lit.bib}

\begin{document}
\setcounter{tocdepth}{2}

\title{YALE DEPARTMENT OF ECONOMICS \\ \vspace*{60pt} The Folly of the Crowd: \\
Market Inefficiencies in Peer-to-Peer Lending}
\author{Samuel Shleifer
  \footnote{I am grateful to Professor Vineet Kumar for his help
  in developing the ideas and statistical methodologies involved in this paper,
  Devin Pope and Rajkamal Iyer for help manipulating the Prosper data, 
  and to Andrei Shleifer, Nicholas Barberis and Andrew Metrick for helpful comments and suggestions.}
  \footnote{R code available at \url{github.com/sshleifer/ProsperThesis}}\\
Thesis Advisor: Vineet Kumar\footnote{Yale School of Management}}
\maketitle

\begin{center}
Essay submitted to the Faculty of the Department of Economics in partial fulfillment
of the requirements for the degree of Bachelor of Arts at Yale University.
\end{center}

\begin{center}
\textbf{Please print in color.}
\end{center}

\afterpage{\blankpage}
\newpage
\begin{abstract}
This essay analyzes the effect of market maker interventions on financial market
efficiency, using data from Prosper.com, the first p2p lending
website in the US.\footnote{P2P lending is the practice of individual and
  institutional investors lending money to borrowers over the internet, without
the presence of a financial intermediary} Between 2006 and 2011, Prosper underwent two
major policy changes that guided and then forced willing investors to lend at higher
interest rates, as well as to reduce their exposure to subprime borrowers.

During the period before either change, investors set interest rates by auction,
made avoidably bad mistakes, and earned poor returns.
After Prosper began guiding investors towards setting higher interest rates,
they made fewer mistakes and returns improved. 

Freedman and Jin (2008) use investor
learning to explain this improvement. This paper expands on their work, 
with the advantage of three additional years of data and two major policy changes. 
I do not find much evidence for investor learning. Rather, I find evidence that
Prosper's rule changes guided and then forced willing investors to make better
decisions. When investors set interest rates by auction, investment strategies using publicly available
information earn excess returns, an inconsistency with the predictions of
the Efficient Markets Hypothesis. Once Prosper begins setting rates,
it is no longer possible to beat the market.
\end{abstract}
\newpage
\tableofcontents

<<init,echo=FALSE,warning=FALSE,results='hide',message=FALSE,cache=FALSE,eval=TRUE>>=
#DONT CACHE SAYS YIHUI
require(dplyr)              ### Used Extensively
require(ggplot2)            ### Used Extensively
require(gridExtra)          ### For facet plots
require(knitr)              ### For chunk control, compilation
require(leaps)              ### For feature selection
require(lubridate)          ### For date grouping, conversions
require(reshape2)           ### For melt() before ggplot
require(scales)             ### For plots
require(texreg)             ### Regression Output using texreg()
require(tidyr)              ### For spread()
require(xtable)             ### Tabular Output using xtable()
options(scipen=999,digits=4,formatR.arrow=TRUE,width=90)
coruse = 'pairwise.complete.obs'
opts_chunk$set(list(fig.path='figure/minimal-', fig.align='center',echo=FALSE,tidy=TRUE,fig.height=5,warning=FALSE, message=FALSE,results='asis',strip.white=TRUE))
hook2 <- function(x){ gsub("```\n+```\n", "", x) }
knit_hooks$set(document = hook2)
@

<<funcs,results='hide',cache=FALSE, echo=FALSE>>=
mlm <-function(formula, data){return(summary(lm(formula,data)))}
mf<-function(ct){return(transform(ct,freq=n/sum(n)))}
ratio <- function(x, y){
  return((x+.0001) /(y + .0001))
}
notNA<-function(df){
  ret = apply(df, 2, function(x) length(which(!is.na(x)))/length(x))
  return(sort(ret))
}
mySumm <- function(df){
  relRows = c('min','max','median','mean','std.dev')
  return(stat.desc(df)[relRows,])
}
me <- function(df){
  relRows = c('mean')
  return(stat.desc(df)[relRows,])
}
keepNumeric <-function(x){
  nums <- sapply(x, is.numeric)
  return(x[ , nums])
}
histos<-function(m) {
  m = melt(m)
  ggplot(m,aes(x = value)) + 
    facet_wrap(~variable,scales = "free_x") + geom_density()
}
dropBoring<-function(fp){
  out <- lapply(fp, function(x) length(unique(x)))
  keep <- which(out > 1)
  return(fp[keep])
}
naRep<-function(col, val){
  col[is.na(col)] <- val
  return(col)
}
charFac<-function(ep){
  i <- sapply(ep, is.factor)
  ep[i] <- lapply(ep[i], as.character)
  return(ep)
}
@

<<readin,cache=FALSE,eval=TRUE>>=
nd = read.csv('Data/loans.csv')
@

<<cleanStrats,cache=FALSE>>=
nd  = filter(nd, nd$LoanStatus %in% c("Chargedoff",'Completed','Defaulted')) %>%
  mutate(Date = as.Date(date)
         ,payments = LP_CustomerPayments + LP_NonPrincipalRecoverypayments
         ,CreditScoreEst = (CreditScoreRangeLower + CreditScoreRangeUpper)/2
         ,dbg = ifelse((LoanStatus=='Completed') & (roi < 0), 1,0)
         ,mgroup = floor_date(Date,"month")) %>%  
  filter(!is.na(CreditScoreEst)) %>% filter(dbg==0) %>% filter(mgroup!="2009-05-01")
nd$dbg<-NULL
catmap= c("NA","Debt Consolidation","Home Improvement", "Business", "Personal", "Student Use", "Auto","Other")
nd$purpose = catmap[nd$ListingCategory..numeric.+1]
nd$spread = round(nd$BorrowerRate - nd$LenderYield, 4)
### SCALING ###
toscale = c('BorrowerRate','CreditScoreEst','TotalCreditLinespast7years','OpenRevolvingAccounts','CreditScoreEst','CurrentDelinquencies','DelinquenciesLast7Years','PublicRecordsLast10Years','DebtToIncomeRatio','StatedMonthlyIncome','TotalProsperLoans','TotalProsperPaymentsBilled','OnTimeProsperPayments','ProsperPaymentsLessThanOneMonthLate','ProsperPrincipalBorrowed','MonthlyLoanPayment','LoanOriginalAmount','CreditScoreEst')

scaled = data.frame(scale(nd[toscale]))
colnames(scaled) = sapply(colnames(scaled),FUN=paste,'.sc', sep='')
nd = cbind(nd, scaled)
nd$CreditScoreEst.1<-NULL
nd$defaulted <- ifelse(nd$LoanStatus=='Completed',0,1)
dis0 = as.Date(mdy("10-16-2008"))
dis1 = as.Date(mdy("12-20-2010"))

old = filter(nd, Date < dis1) #TODO (remove this)
o1 = filter(old, Date <= dis0) %>% transform(grade=CreditGrade, regime="Auction-Early")
o2 =  filter(old, Date > dis0) %>% transform(grade=ProsperRating..Alpha., regime="Auction-Late")
old = rbind(o1,o2)
n = filter(nd, Date >= dis1) %>% transform(grade = ProsperRating..Alpha., regime="Prosper-rate")

navec = apply(keepNumeric(old), 2, function(x) length(which(!is.na(x)))/nrow(old))
drops = names(navec[navec==0])
old  = old[,!(names(old) %in% drops)]
n  = n[colnames(old)]

n$regime = 'Prosper-rate'
nd =rbind(old,n)

###Train, test Split for full-data Regressions
nd$regimeBool = ifelse(nd$regime=='Auction-Early', 0, 1)
nd$holdout = ifelse(nd$ListingKey %in% sample(nd$ListingKey, nrow(nd)/2), 1,0)  
fulltrain = filter(nd, holdout == 0); fulltest = filter(nd, holdout == 1)
#####LOOKAHEAD FIX#####
cut1= median(o1$Date); cut2 = median(o2$Date); cut3 = median(n$Date)
o1= mutate(o1
             ,cutDays = as.numeric(difftime(cut1, ymd(Date),units='days'))
             ,maturity = cutDays/1095
             ,def = ifelse((roi+1) < maturity, 1, 0))
train = filter(o1, Date < cut1); test = filter(o1, Date >=cut1)
o2= mutate(o2
             ,cutDays = as.numeric(difftime(cut2, ymd(Date),units='days'))
             ,maturity = cutDays/1095
             ,def = ifelse((roi+1) < maturity, 1, 0))
tr2= filter(o2, Date < cut2); te2 = filter(o2, Date >=cut2)

if(FALSE){
  ###ATTEMPT AT KNOWN-ROI
  train$owed = train$LoanOriginalAmount * train$maturity
  train$kpay  = ifelse((train$LoanStatus != 'Completed') & (train$payments >= train$owed),
                       train$owed, train$payments * train$maturity)
}

n = mutate(n
           ,cutDays = as.numeric(difftime(cut3, ymd(Date), units='days'))
           ,maturity = cutDays/1095
           ,def = ifelse((roi+1) < maturity, 1, 0))
tr3= filter(n, Date < cut3); te3 = filter(n, Date >= cut3)
stopifnot(length(nd$regime) > 0)
@

<<featSelection0,results='hide',cache=FALSE>>=
numvars = 8 #Number of features to select
##With Scaled Data###
bigReg1.sc = regsubsets(def ~
                          BorrowerRate.sc + TotalCreditLinespast7years.sc + OpenRevolvingAccounts.sc + OpenRevolvingMonthlyPayment + InquiriesLast6Months + TotalInquiries + CurrentDelinquencies.sc + DelinquenciesLast7Years.sc + PublicRecordsLast10Years.sc + DebtToIncomeRatio.sc + StatedMonthlyIncome + TotalProsperLoans.sc + TotalProsperPaymentsBilled.sc + OnTimeProsperPayments.sc + ProsperPaymentsLessThanOneMonthLate.sc + ProsperPaymentsOneMonthPlusLate + ProsperPrincipalBorrowed.sc + MonthlyLoanPayment.sc +CreditScoreEst.sc + StatedMonthlyIncome.sc
                        ,nbest=1
                        ,nvmax=numvars
                        ,intercept=TRUE
                        ,really.big=TRUE
                        ,data = train)

bigReg2.sc = regsubsets(def ~
                          BorrowerRate.sc + TotalCreditLinespast7years.sc + OpenRevolvingAccounts.sc + OpenRevolvingMonthlyPayment + InquiriesLast6Months + TotalInquiries + CurrentDelinquencies.sc + DelinquenciesLast7Years.sc + PublicRecordsLast10Years.sc + DebtToIncomeRatio.sc + StatedMonthlyIncome + TotalProsperLoans.sc + TotalProsperPaymentsBilled.sc + OnTimeProsperPayments.sc + ProsperPaymentsLessThanOneMonthLate.sc + ProsperPaymentsOneMonthPlusLate + ProsperPrincipalBorrowed.sc + MonthlyLoanPayment.sc +CreditScoreEst.sc + StatedMonthlyIncome.sc
                        ,nbest=1
                        ,nvmax=numvars
                        ,intercept=TRUE
                        ,really.big=TRUE
                        ,data = tr2)

bigReg3.sc = regsubsets(def ~
                          BorrowerRate.sc + TotalCreditLinespast7years.sc + OpenRevolvingAccounts.sc + OpenRevolvingMonthlyPayment + InquiriesLast6Months + TotalInquiries + CurrentDelinquencies.sc + DelinquenciesLast7Years.sc + PublicRecordsLast10Years.sc + DebtToIncomeRatio.sc + StatedMonthlyIncome + TotalProsperLoans.sc + TotalProsperPaymentsBilled.sc + OnTimeProsperPayments.sc + ProsperPaymentsLessThanOneMonthLate.sc + ProsperPaymentsOneMonthPlusLate + ProsperPrincipalBorrowed.sc + MonthlyLoanPayment.sc +CreditScoreEst.sc + StatedMonthlyIncome.sc
                        ,nbest=1
                        ,nvmax=numvars
                        ,intercept=TRUE
                        ,really.big=TRUE
                        ,data = tr3)
@

<<testFuncs,results='hide',cache=FALSE>>=
makeForm<-function(bigReg, y = 'roi ~ grade +'){
  #FOR FEATURE SELECTION
  if(is.recursive(summary(bigReg))){
    wh = summary(bigReg)$which
    vars = names(wh[numvars,][wh[numvars,]==TRUE])[1:numvars+1]  
    form = paste(y, paste(vars,collapse=' + '), sep=' ')    
  }else{
    print('FAILING TO AUTOMATE FEATURE SELECTION')
    form = "roi ~ BorrowerAPR + OpenRevolvingAccounts + InquiriesLast6Months + TotalInquiries + CurrentDelinquencies + DelinquenciesLast7Years + MonthlyLoanPayment + CreditScoreEst"
  }
  return(form)
}

regTest<<-function(reg, test, fg=10){
  if(nrow(test)==1) return(as.numeric())
  test$predicted = predict(reg,test)
  breaks=quantile(test$predicted, probs=seq(0,1, by=.1), na.rm=TRUE)
  test$fitgroup <- as.numeric(cut(test$predicted, breaks=breaks, include.lowest=TRUE))
  return(subset(test, test$fitgroup==fg)$roi)
}

ruleTest<-function(train){
  inq = quantile(train$TotalInquiries, probs=(.4), na.rm=TRUE)
  amt = quantile(train$LoanOriginalAmount, probs=(.4), na.rm=TRUE)
  best = subset(train, train$TotalInquiries < inq & train$LoanOriginalAmount < amt)
  return(best$roi)
}
meanUL<-function(vec){return(mean(unlist(vec),na.rm=TRUE))}
sdUL<-function(vec){return(sd(unlist(vec),na.rm=TRUE))}
@
\section{Introduction}
Historically, there are two major perspectives on efficient market prices. Fama
(1970)'s semi-strong efficient markets hypothesis ("EMH") predicts that a
strategy using publicly available information should not be able to earn excess
risk-adjusted returns. Risk models such as CAPM imply that risky assets should
have positive expected returns and that riskier assets should have higher
returns than less risky assets.\footcite{sharpe} The information aggregation perspective
associated with Hayek (1945) and Stiglitz and Grossman (1980), further
predicts that many individuals, each using their own information, collectively
arrive at a more efficient price than a central agent who sets prices, since the
agent cannot access all the information available to the crowd.\footcite{stiglitz}\footcite{hayek}

In the P2P Lending context, the market's price is the interest rate charged on a
loan. This paper studies the question of whether interest rates on Prosper.com
are set efficiently. Fama (1970)'s semi-strong EMH predicts that if interest rates were set efficiently, then...
\begin{enumerate}
\item Loans would have positive expected returns. Investors would be unwilling
  to lend to Borrowers if they expected to lose money. \footnote{Assuming a
  Risk-Free Rate of 0.}
\item Riskier loans would have higher expected returns. \footcite{sharpe}
\item It is not possible to do better than the average investor using publicly available information. \footcite{fama}
\end{enumerate}
Hypothesis 1 is tested by measuring historical returns of loans to borrowers of
each credit grade.
Hypothesis 2 is tested by comparing the returns of high risk loans to low risk
loans.
Hypothesis 3 is tested by using publicly available information to select loans
with a higher than average expected return, without look-ahead bias.

Prosper.com data provide some additional valuable insights into investor
behavior. Over the period I study, there are three interest rate determination regimes:
\begin{enumerate}
\item Early Auction Regime (April 19, 2006-October 15, 2008): Rates are set by
  investor auction. Investors have easy access to useful data, but Prosper does not guide them meaningfully.
\item Late Auction Regime: (July 20, 2009-December 19, 2010): Rates are set by
  investor auction, with Prosper offering valuable guidance in the form of more
  complex credit grading. 
\item Prosper-rate Regime: (December 20, 2010 - August 3, 2011): Prosper sets
  rates without investor input using its more complex credit grading algorithm.
\end{enumerate}
Additionally, for regimes (2) and (3), subprime borrowers are not allowed to
apply for Prosper loans.

A comparison of loan performance in different regimes allows me to consider
two contrasting views of how an internet marketplace such as Prosper works.
One view, closely linked to Hayek, suggests that the marketplace would work
best with minimal intervention from the market maker Prosper, so many
individual lenders incorporate their private knowledge and information in
the determination of the interest rate.   An opposing view would hold that
individuals are not sophisticated or knowledgeable enough to assess loan
risk, and some guidance or even interest rate setting from Prosper, the market
maker, would improve loan performance. The evidence on loan returns in the
three regimes points quite clearly in favor of the market maker hypothesis
as Prosper becomes more involved in the rate-setting process,
the excess returns available using publicly available information approach 0,
while aggregate investor returns exhibit higher mean and lower variance.

A major confound of this analysis is the time period. Perhaps 2006-2008, the
early auction period, is just a bad time to invest in consumer credit, whereas
2009-2011 is much better. To address this concern, I estimate the importance of
time effects by comparing default rates of loans to similar borrowers in
different periods. I then show that time period is not the only explanation of
the various changes to the marketplace by estimating what loan performance would
have been if pre-shutdown borrowers borrowed at the higher Prosper-set interest
rates. 

This hypothetical method suffers from the problem that it is impossible to
perfectly simulate the effect of charging risky borrowers higher interest rates
during a turbulent macroeconomic period, as Section 6 attempts.
A perfect dataset would have Prosper randomly assign different rate-setting
mechanisms to borrowers, rather than assigning all borrowers in a given time
period the same rate-setting mechanism, and then switching it when things aren't
going well.


In this spirit, I do not claim that poor investor decision making is the only
factor causing poor returns in the Early auction period, or that the impact of
the policy changes can be fully isolated by my methodologies.
The inconsistencies with EMH predictions 1 and 2 can certainly be partially
explained by the same bad luck that explains poor returns on all risky assets
during economically turbulent times.
I merely argue that returns in the early auction period were likely made worse
by poor investor decisions, as evidenced by the predictable mispricings that
could be exploited. In Section 5, I show that over a somewhat longer period of time, simple loan
selection strategies can use publicly available information to earn higher
returns than the benchmark.\footnote{Benchmark is calculated by assuming \$1 investment in every available loan.}

Much of the evidence presented in this essay is inconsistent with an explanation
that all of the differences between regimes can be explained by differences in
time period. For example, in the late auction regime, when investors set
interest rates, strategies using publicly available information can earn excess
returns. In the Prosper-rate regime, when Prosper sets interest rates directly,
they cannot. The two periods are very similar macroeconomically. Perhaps most tellingly,
in the period when Prosper sets rates it seems to use similar variables to those
that were helpful in selecting the best performing loans in the early auction
regime, pointing strongly toward the conclusion that early investors were not using
publicly available information effectively.

\subsection{Background}
Peer-to-peer lending (``P2PL")  is the practice of lending money to borrowers
over the internet, without going through a traditional financial
intermediary.\footcite{p2pwiki} From April 2006 until December 2010, interest
rates were set by lenders\footnote{For the purposes of this essay, lender and
investor are synonyms.}, who competed for the lowest rate in a reverse auction
model.

In October 2008, Prosper was shut down by the SEC because it was designated as
a seller of securities,\footnote{Rather than, as it argued, a marketplace
connecting buyers and sellers.} and re-opened in July 2009
after a 9 month quiet period with more stringent under-writing standards, and
greater guidance for lenders. Importantly, all the information about borrower
creditworthiness that is used in this paper is similar to what was available to
investors when they bid on loans. Since December 2010, the beginning of the
\textit{Prosper-rate} regime, rates have been determined by Prosper, on the
basis of a borrower's credit history, as provided by Experian.

\begin{table}
  %\renewcommand\arraystretch{1.4}\arrayrulecolor{LightSteelBlue3}
  %\captionsetup{singlelinecheck=false, font=blue, labelfont=sc, labelsep=quad}
  \caption{Timeline of Events}\vskip -1.5ex
  \begin{tabular}{@{\,}r <{\hskip 2pt} !{\foo}
    >{\raggedright\arraybackslash}p{12cm}}
    \toprule
    \addlinespace[1.5ex]
    Apr. 21, 2006 & First loan of early auction regime.\\
    Mar. 1, 2007 & Prosper bans borrowers with credit score $\leq$ 520.\\
    Oct. 15, 2008 & Early Auction period ends with SEC enforced shutdown.\\
    Jul. 20, 2009 & Prosper reopens with more informative credit grades, requires repeat borrowers to have credit score
    $\geq$ 600, and requires new borrowers to have credit score $\geq$ 640.
    Beginning of Early Auction Regime.\\
    Dec. 19, 2010 & Prosper-rate regime, where Prosper sets rates directly,
    begins, because ``auctions made the deployment of funds more time consuming
    with little gain in lender returns.” - Prosper CEO Chris
    Larsen.\footcite{renton}\\
    Aug. 3, 2011 & Last loan in Prosper-rate regime originated.
  \end{tabular}
\label{timeline}
\end{table}

Under all three regimes, lenders could choose to whom to lend and how much to
lend, allowing them to diversify across many loans, thereby decreasing the
variance of their returns. The minimum investment in a loan was \$25, with no
maximum, and lenders could hold as many loans as they wished.
Before a potential borrower's listing is posted on the website, Prosper authenticates their social security number, driver's
license and address, and pulls the borrower's credit history from Experian,
which includes credit score, total number of delinquencies, current
delinquencies, and many other historical credit variables.\footcite{freedman} 
In exchange for verifying borrowers' identities and managing the
marketplace, Prosper charges a 0.5-3 percentage
point origination fee on each loan depending on the borrower's risk profile and
loan duration. 
This fee,usually 1\%, is added to the borrower's monthly payment.
Lenders are also charged a servicing fee of 0.5-1\%. There are no prepayment penalties.
This rate is lower than that charged by most traditional financial institutions, which have the higher costs of physical branches, and pay for human analysis of credit history.\footcite{hanson}
The P2PL model relies on lenders being able to infer the riskiness of borrowers: since Prosper gets fees from monthly payments, they too are incentivized to maximize investor returns, both for short term profit, and long term reputation.

In my sample, Prosper's origination volume, as shown in Figure \ref{fig:origTime}, peaked in the months before the shutdown, and then slowly resumed after the quiet period. Since 2011, when the sample ends, origination volume has eclipsed its 2008 peak.
<<origTime, cache=FALSE, fig.cap='This chart shows two panels. The first panel shows the number of loans funded on Prosper.com in each month of the sample. The second panel shows the total dollars lent to borrowers on Propers.com in each month of the sample.'>>=
g2 = group_by(nd, mgroup, regime) %>%
  summarise(Number_Of_Loans = length(mgroup) 
            ,Dollars_Lent = sum(LoanOriginalAmount)) %>%
    melt(id.vars = c("mgroup",'regime'))

ggplot(g2, aes(x=mgroup,fill=regime)) +
  geom_area(aes(y=value)) +
  facet_wrap(~variable,nrow=2,scale='free_y')+
  scale_x_date(labels=date_format('%b-%y')) +
  scale_y_continuous(labels=comma) +
  theme_bw()+
  labs(title='Prosper: Loan Origination by Month', x='Month', y='Number of Loans',fill='Regime')
@

<<catsTab, cache=FALSE>>=
catTab = filter(nd, purpose != "NA") %>% count(purpose, sort=TRUE) %>% mutate(Frequency = n/sum(n))
colnames(catTab) = c('Purpose','n','Frequency')
xtable(catTab, digits=3, label='catTab', caption = "Stated reasons for borrowing on Prosper (2006-2001). NAs removed.")
@

Reasons for borrowing on Prosper, as shown in Table \ref{catTab}, have changed relatively little over the site's 8 year history: the plurality of borrowers aim to consolidate credit, while fewer use the funds to start a business, or pay for a wedding or a car.
Morse (2015) finds that ``Borrowers are characterized as debt-laden, middle-to-high income, individuals who are consolidating credit cards and other debt." The average P2P loan face value comprises 20.5\% of annual income, and payments absorb 7.5\% of monthly income.\footcite{morse}

\subsection{Auction Design}
From April 19, 2006 until December 19, 2010. Prosper operated a \emph{variable
rate} model, where lenders and borrowers determined interest rates using a Dutch
auction-like system, where each investor bid consisted of a (dollar amount,
interest rate) pair, such that the dollar amount is greater than \$50, the
minimum bid, and the rate is capped at the borrower's reservation
rate.\footcite{freedman}
In these auctions, borrowers would declare a maximum reservation interest
rate, capped at 36\%, where bidding would start. Over the course of a 7-10 day bidding period, that rate would be bid down by investors, with the loan's interest rate closing at the lowest rate $R_{clearing}$ such that enough investors were willing to fully fund the loan at or below the $R_{clearing}$. All investors who bid at or below the clearing rate would receive the clearing rate. If a borrower could not reach 100\% funding at his reservation rate, the loan would not be funded.

As an illustrative example, suppose Bill the borrower needed to borrow \$100, and set his maximum rate at 20\%.
Let Chris, David and Ellen be investors, with Chris bidding (\$50, 15\%), David bidding (\$50, 18\%) and Ellen bidding (\$30,19\%). In this scenario, Chris and David would win the auction, and each lend lend Bill \$50, and receive an 18\% interest rate. Bill would pay 18\% interest before fees.
\subsection{Early Auction Regime}
In the early auction regime, loans originated between April 19, 2006 and October
15, 2008, auction participants had access to considerable information from
Prosper, including over 60  Borrower characteristics, such as residence,
employment status and an Experian credit score bucket, but few intelligent risk
estimates. Additionally, Prosper did not regulate who could apply for a loan on
the website. Besides basic fraud prevention, any applicant who received 100\%
funding from investors was eligible, for Prosper's first year of operation. On
March 1, 2007, amidst poor returns, Prosper announced that listings with credit
scores below 520 would no longer be offered to investors. This intervention is
not discussed in depth, for lack of space, but shows that after a year, more or less, Prosper felt the need to nudge a fully decentralized investment process in the right direction.

In an October 15, 2008 email, Prosper announced that it would temporarily stop accepting new loan applications to register with the SEC, which subsequently released a cease and desist order characterizing Prosper as a ``seller of securities," rather than a marketplace merely matching lenders and borrowers, as the site had argued.\footcite{sec}

\subsection{Late Auction Regime}
After a 9 month quiet period, Prosper re-opened, using the same Auction model,
with three significant market interventions. First, under-writing standards
again became more stringent: new borrowers were required to have a credit score score above 640, and repeat borrowers were required to have a score above 600. 

Second, whereas previously Prosper used only the credit score to determine a borrower's Credit Grade (eg. AA), the site began offering a more advanced, multi variable formula to determine each borrower's credit grade for investors consideration. Finally, the site also partnered with FolioFN, a secondary market where lenders could liquidate their positions. Crucially, Prosper still had no direct role in setting interest rates, investors still used an auction, but with the extra information credit grades that more closely matched default probabilities. 
Besides credit score, Prosper began using (and still uses) the following ``Key
variables" to determine its revamped credit grades:\footcite{estloss}
\begin{itemize}
\item  TotalInquiries: The number of times potential lenders requested the borrowers' credit portfolio from the credit bureau, which is usually Experian or a competitor.
\item CurrentDelinquencies: The number of delinquent loans associated with the borrower.
\item Credit card utilization: how much of available credit the borrower uses on a monthly basis.
\item Number of open credit card accounts
\item Debt to income ratio
\item Loan payment performance on prior Prosper loans.
\end{itemize}
This Auction rate-setting mechanism continued for more than a year after the shutdown, until December 19, 2010.

Unsurprisingly, but critically for the interpretation of the evidence,
the automated feature selection procedure in section 5, which
identifies the subset of variables that best predict default, finds that
credit Score, inquiries, delinquencies and number of credit cards are all useful
independent variables for predicting default.

\subsection{Prosper-rate Regime}
Under the current \emph{Prosper-rate} model, enacted December 20, 2010, lenders
no longer determine the loan rate in an auction. Instead, Prosper uses the
intelligent credit grades given to investors in the late auction regime to set
interest rates on loans, with slightly less stringent under-writing standards to
determine eligibility. The change was motivated by a desire to accelerate the
listing process, so that investors could reinvest money more quickly. Moreover,
towards the end of the late auction regime, auctions were arriving at interest
rates that were almost completely determined by the credit grade. Under the
fixed-rate regime, investors choose whether or not to invest in a given loan, at
the interest rate set by Prosper, so bids consist only of a dollar amount.

\section{Literature}
\subsection{Efficient Markets Hypothesis}
In layman's terms, the efficient markets hypothesis (EMH), states that 'it is
impossible to beat the market.' More specifically, Fama explains, market prices should always fully reflect publicly available information. Therefore, EMH rules out the possibility of strategies that earn excess returns using only publicly available information. \footcite{fama}
In the P2P lending context, this market price is the interest rate determined by investors (or accepted by investors in the fixed-rate regime), and paid by the borrower, and returns are the cash flows received from borrowers divided by the amount invested.

Fama, (1970) notes the dependence of most tests of market efficiency on a model of risk and return.
The models, including most famously, Sharpe's capital asset pricing model (CAPM), make two predictions:
First,  since an investor can always hold cash risklessly, the average return on risky investments must be positive. Second, securities with higher systematic risk earn higher average returns.\footcite{sharpe}

The EMH rests on three assumptions. ``First, investors are assumed to be rational and hence to value securities rationally. Second, to the extent that some investors are irrational, their decisions are random and uncorrelated. Third, to the extent that some investors are irrational in similar ways, they are met in the market by rational arbitrageurs, who eliminate their influence on prices."\footcite{as}

In a reverse interest rate auction, such as Prosper's market design, arbitrageurs cannot short a borrower and increase his interest rate.  In the situation where irrational investors under estimate a borrower's riskiness, they will outbid rational bidders, and set the market price. To earn excess returns, then, an investor must select loans for which other investors have demanded too high a rate, so that he can participate in funding.


\subsection{Soft Information and Credit Screening}
The novel idea of P2P is a large group of investors may be better equipped to assess risk than traditional financial institutions. ``Traditionally, the credit score provided by rating agencies has been the main tool banks use to screen smaller borrowers."\footcite{iyer} As such, the initial strand of literature focuses largely on the novel sources of information utilized by P2P investors.
Gao and Lin (2012) analyze the text written by the borrower in the ``description
field" of the loan application, and find that descriptions that are easy to read have
2.3\% lower default rates than average, while complex narratives are associated
with a 3.6\% higher default rate. They do not measure returns.\footcite{gao}
Pope and Sydnor (2008) find that investors reduce
their defaults by statistically discriminating against racial minorities, but
also do not analyze return on investment.
Iyer et. al (2009) find that within the credit score buckets provided by Prosper, investors use soft information to further sort borrowers within buckets, reducing defaults.\footcite{iyer}

These papers echo Hayek (1945)'s basic argument for market efficiency: that many
individuals, each using their own information, collectively arrive at one
efficient price.  The right price ``might have been arrived at by one single
mind possessing all the information which is in fact dispersed among all the
people involved in the process."\footcite{hayek} 

Freedman and Jin (2008) are more focused on the failures of the auction regime,
Although the main focus of their paper is the role of soft information and
social networks on Prosper, they also study how investors learn to weight these
different variables, and, like this paper, find negative expected returns in the
early auction regime: ``lenders, especially those that joined
Prosper early, did not fully understand the market risk. We estimate, on
average, Lenders would have expected an internal rate of return of between
-.62\% and
1.38\% if they had correctly understood the risk distribution of Prosper
loans.''``Vigorous'' lender learning, they argue, explains the increase in interest
rates and borrower creditworthiness, and associated increase in lender
returns.\footcite{freedman}

This essay continues Freedman and Jin's critical look at investor decisions in the early
auction regime, but with the benefit of three more years of data, and two more
major Prosper policy changes: informative grading and centralized rate-setting.
Instead of a focus on soft information and social networks, I describe the hard information that
went largely ignored by investors until Prosper aggregated it into more
informative credit grades. Instead of investor learning as the catalyst that led
to a more efficient market, I frame Prosper's rule changes as catalysts that
force investors to make better decisions.

Inconsistent with Hayek, the data suggest that when investors are left on their own
to set prices, markets are not nearly as efficient as the prices set by ``a
single mind'', namely a market maker who aggregates the data. Furthermore, as interest rate setting becomes more centralized, interest rates become more sensitive to the hard credit variables that best predict default.

\section{Data}
My sample consists of 39,555 three year, unsecured (no collateral) Loans, worth
\$231.7 Million,  originated from 2006-2011. The data was downloaded off Prosper.com.
Borrowers apply for loans by creating a public listing on the Prosper.com website, and can request anywhere from \$1,000 to \$35,000.\footnote{The minimum increased to \$2,000 effective Nov. 1, 2011}.
Since our analysis requires measurement of loan performance, which can only take
place three  years after origination (given 3 year maturity on all loans), the
sample is ended in 2011, as we do not know what will end up happening to more recently originated loans. 
As shown in Table \ref{sample}, this leaves us with many more loans from the
early auction regime than the post shutdown regimes.
<<sampTab, cache=FALSE>>=
samp.tab = mf(count(nd,regime))
colnames(samp.tab) = c('Regime','n','Freq.')
xtable(samp.tab,kdigits=4, caption='Observations per regime. Each observation is
one funded loan.', label='sample')
@

To help investors better assess the creditworthiness of borrowers, for every
loan originated in the site's history, Prosper posts historical data regarding loan
performance, such as payments made, interest rate, and principal lost.
Additionally, borrower
characteristics, including credit variables obtained from Experian and
verification of which are usually obtained directly
from Experian and verification of income and employment, are available to
investors for each listing. Moreover, historical market data is available for
download, through a query tool, and through third party websites. 
Interviews conducted at the 2008 Prosper Days Conference suggest that there was
``enormous heterogeneity in lender awareness of the data, ability to process the
data, and intent to track the data over time.''\footcite{freedman}

\subsection{Variable Definitions for the Prosper Data}
<<sumTable,cache=FALSE>>=
nd$default.rate =  nd$defaulted
k4 = c('roi','default.rate', 'LenderYield','BorrowerRate','regime','LoanOriginalAmount','Investors','CreditScoreEst','DebtToIncomeRatio', 'InquiriesLast6Months')
ag4 <- aggregate(.~regime, nd[k4], function(x) c(mean = mean(x), sd = sd(x)))
d4 = t(do.call(data.frame, c(ag4, check.names = FALSE)))
d5 = data.frame(d4)
names(d5) = d4[1,]
d6 = d5[-1,]
xtable(d6,caption='This table presents means (.mean) and standard deviations
(.sd) for relevant variables by regime.',digits=3, label='sumStats')
@
For each loan, Prosper offers 63 variables, I now define an important subset.
\begin{itemize}
\item BorrowerRate: Annual interest rate paid by the borrower.
\item TotalCreditLinespast7years: Number of credit lines, including cards and loans, used by the borrower in the seven years before the prosper loan was originated.
\item Inquirieslast6Months: Number of times a lender inquired about the Borrower's credit report, in the 6 months before the loan was originated. Traditional lenders make inquiries when a borrower applies for a loan, so this serves as a proxy for the number of times someone has borrowed in the past 6 months.
\item CurrentDelinquencies: Number of loans on which the borrower is delinquent at the origination date.
\item DelinquenciesLast7Years: The number of loans which the borrower has not repaid fully over the 7 years before the origination date.
\item MonthlyLoanPayment: The borrower's scheduled monthly payment on the Prosper loan.
\item CreditScoreRangeLower: The lower bound of the credit score range (which
  bounds his raw credit score) , that bounds a borrower's credit grade, as
  provided by Experian. Prosper provides the range instead of the raw score to
  preserve borrower anonymity.
\item CreditScoreEst: The average of the lower and upper bounds of the credit score range. 
\item PublicRecordsLast10Years: Number of public records of borrowing activity in the past 10 years at the origination date. 
\item DebtToIncomeRatio: The debt to income ratio of the borrower at the origination date. This value is capped at 10.01 (any debt to income ratio larger than 1000\% will be coded as 1001\%).
\item TotalProsperPaymentsBilled: Number of on time payments the borrower made on Prosper loans at the time they created the listing. This value is 0 if the borrower had no prior loans.
\item LenderYield: The lender's yield on the loan. Equal to the interest rate minus servicing fee.
\item BorrowerRate: The borrower's interest rate for the loan.
\item Investors: The number of investors that funded the loan.
\item *.sc: The Variable * was scaled to have 0 mean and unit variance. (found only in regression results)
\end{itemize}

\subsection{Measuring Loan Performance with ROI}
<<roivstatus,cache=FALSE,fig.height=3,fig.cap="This chart shows the distribution of ROI for all completed and defaulted loans in the sample. A continuous ROI variable offers more information about the quality of an investment than a binary default indicator. Dotted lines indicate mean ROI for category.",fig.height=3,fig.pos='H'>>=
nd$d.factor =  ifelse(nd$defaulted == 1, 'Defaulted','Completed')
smeans = summarise(group_by(nd,d.factor), mRoi = mean(roi, na.rm=TRUE))
ggplot(nd, aes(x=roi,fill=d.factor)) +
  geom_histogram(binwidth=.01)+ 
  geom_vline(data=smeans, aes(xintercept=mRoi,color=d.factor),linetype='longdash') + 
  theme_bw() +
  labs(title='Distribution of ROI for each Loan Outcome (all regimes)', x='ROI',y='Count',fill='Loan Status') +
  scale_x_continuous(limits=c(-1, 1), breaks=seq(-1,1,by=.25),label=percent) +
  facet_wrap(~d.factor,ncol=1,scales='free_y')
  @

In order to capture the actual impact of a loan on an investor's portfolio, we measure the ROI for a given loan as the sum of the borrower's payments / amount borrowed -1.
\begin{equation}
ROI = \frac{amount.repaid}{amount.borrowed} -1
\end{equation}
As shown in
Figure \ref{fig:roivstatus}, a return on investment variable offers much more
granularity than a binary default variable for both defaulted and repaid loans.
In many observations, a borrower paid back over half his principal before
defaulting. A binary indicator would treat this loan, which only cost the
investor half his money, as identical to a loan that repaid him nothing. 
Additionally, a default indicator fails to account for the higher interest
payments associated with riskier loans. Still, measuring ROI and default lead
to similar conclusions, as the correlation between ROI and default is -.80 over the full sample.

I do not discount or annualize ROIs, because in the period of low interest
rates, the difference between default and repayment is large enough that a few
percentage points don't matter: loans that default average -46\% ROI, loans that
repay average + 24\% ROI. Furthermore, my ROI results are very similar to Freedman
and Jin's, who use discounting.\footcite{freedman} Although their sample is
shorter in length, using discounted ROIs for our sample would only make the
results more extreme, as risk-free interest rates were highest during the early
auction regime.\footcite{fred} \footnote{The fed funds rate's peak during our sample, is at 5\% in 2007, during the early auction regime. It then falls to near 0 for the duration of the later two
  regimes. Discounting would thus lead to significantly lower early auction regime
 ROIs, but only slightly lower ROIs in the later two periods.}

The rest of this paper presents my results, which are divided into three sections.
Section 4 presents facts about the performance of loans across regimes which
suggest that early auction regime investors were not sufficiently sensitive to
risk, and that this partly explains the poor returns of the period. Section 5 tests and rejects
the EMH prediction that it should be impossible to earn excess returns
using publicly available information. Section 6 attempts to isolate the impact
of Prosper's policy changes by controlling for time period effects, and finds
that they explain at least some of the improvement in investor returns. 

\section{Performance Across Regimes}
This section begins with an examination of ROIs over time and across
borrower credit buckets. I then discuss regime differences in default rates and
interest rates, the two features that largely determine returns.
The discussion of interest rates includes measurement of investors' varying sensitivity to risk
across regimes. The section closes by examining the impact on investor returns
of Prosper's interventions, which reduce the valid borrower pool to a less-risky
subset and assign borrowers more informative credit grades.

I find the following: (1) the mean ROI of early auction regime loans is
negative, (2) in the early auction regime, average ROI is lower for higher risk
loans, (3) interest rates are insufficiently sensitive to risk in the early
auction period and (4) investors made sub-optimal choices, given the information
they had at their disposal, and (5) In the period when Prosper intervened,
interest rates and investor returns were much higher, and part of the increase
is likely due to Prosper's intervention.

These findings suggests that although investors were also unlucky in
the early auction regime, they made avoidably bad decisions that hurt their
returns. More specifically,
Finding (1) is inconsistent with the EMH prediction that risky assets like Prosper loans should offer investors a positive expected return.\footnote{Otherwise, investors would just hold cash.}
Finding (2) is inconsistent with the prediction that riskier loans should have higher expected returns to compensate investors for taking risks.
Finding (3) describes the sub-optimal investor decisions that led to (1) and
(2), and in part addresses arguments that investors chose an unlucky time period.
Finding (4) is inconsistent with Hayek's notion that a free market will arrive
at accurate prices that reflect the information available to market
participants,without the meddling of a market maker.

As the default data demonstrate, Finding (3) is only partially responsible for
Findings (1) and (2); investors were incredibly unlucky to have chosen to invest
in risky assets during turbulent macroeconomic times that many of the most
sophisticated investors did not see coming. In section 6, I attempt to control
for this time period effect to isolate the impact of the policy changes.

<<figPrep0,cache=FALSE>>=
mmeans = summarise(group_by(nd,mgroup,regime)
                   , mdef = mean(defaulted,na.rm=TRUE)
                   , sd.def = sd(defaulted, na.rm=TRUE)
                   , mRoi = mean(roi, na.rm=TRUE)
                   , sd.roi = sd(roi, na.rm=TRUE)
                   , mRate = mean(LenderYield, na.rm=TRUE)
                   , sd.rate = sd(LenderYield, na.rm=TRUE)
                   , mcs = mean(CreditScoreEst, na.rm=TRUE)
                   , sd.cs = sd(CreditScoreEst, na.rm=TRUE)
                   , numLoans=length(roi)
                   , dollars = sum(LoanOriginalAmount) / 1000000) %>% mutate(mcs.up = mcs+sd.cs, mcs.down=mcs-sd.cs)

mm2= summarise(group_by(nd,mgroup,regime, CreditScoreEst)
                   , mdef = mean(defaulted,na.rm=TRUE)
                   , sd.def = sd(defaulted, na.rm=TRUE)
                   , mRoi = mean(roi, na.rm=TRUE)
                   , sd.roi = sd(roi, na.rm=TRUE)
                   , mRate = mean(LenderYield, na.rm=TRUE)
                   , sd.rate = sd(LenderYield, na.rm=TRUE)
                   , numLoans=length(roi)
                   , dollars = sum(LoanOriginalAmount) / 1000000) %>% filter(numLoans > 5)

app = filter(nd, regime=='Auction-Early', CreditScoreRangeLower > 520)

mm3  = filter(nd, CreditScoreEst == 649.5) %>%
  group_by(mgroup,regime) %>% summarise(mdef = mean(defaulted,na.rm=TRUE)
                   , sd.def = sd(defaulted, na.rm=TRUE)
                   , mRoi = mean(roi, na.rm=TRUE)
                   , sd.roi = sd(roi, na.rm=TRUE)
                   , mRate = mean(LenderYield, na.rm=TRUE)
                   , sd.rate = sd(LenderYield, na.rm=TRUE)
                   , mcs = mean(CreditScoreEst, na.rm=TRUE)
                   , sd.cs = sd(CreditScoreEst, na.rm=TRUE)
                   , numLoans=length(roi)
                   , dollars = sum(LoanOriginalAmount) / 1000000
                   , mInq = mean(TotalInquiries)) %>% filter(numLoans > 5)

@

\subsection{ROI Across Regimes}
<<roivtime,cache=FALSE,fig.height=3, fig.cap="This chart shows the mean ROI of loans originated each month in our sample. The thick blurred lines show the average ROI across all loans. The solid lines show is the average ROI for loans to borrowers in the 640-660 credit score bucket. The color of each line represents the regime. Loans funded after the shutdown are associated with higher ROI, even controlling for borrower creditworthiness.">>=
ggplot() +
  geom_line(aes(x=mmeans$mgroup, y=mmeans$mRoi,color=mmeans$regime),alpha=.5,size=5) + 
  geom_line(aes(x=mm3$mgroup, y=mm3$mRoi,color=mm3$regime),size=2) + 
  theme_bw() +
  labs(title='ROI Over Time', color='Regime',x='Origination Month',y='Mean ROI')+
  scale_y_continuous(label=percent,limits=c(-.2,.3))
@

Figure \ref{fig:roivtime} shows the performance of loans originated in each
month of the sample. The blurred lines represent the mean return across all
loans for each month, while the solid lines represents the mean return to
borrowers in the 640-659 credit score bucket, which was chosen because it is the
most common in the full sample. 
The average ROI of all loans increases from \Sexpr{mean(o1$roi,na.rm=TRUE)*100}\% in the early auction period to \Sexpr{mean(o2$roi,na.rm=TRUE)*100}\% in the late auction period.
The average return for loans originated in each of the site's first 27 months is
negative, rejecting the EMH prediction of positive expected returns for risky assets. Of course, the time period is unusual. I address this possibility in section 6.
<<roivscore,cache=FALSE,fig.height=3,fig.cap='This chart shows the mean ROI by borrower credit bucket, under each regime. The thickness of the line represents the number of loans originated to borrowers in the credit bucket. In the early auction regime, higher risk loans earn lower average returns.'>>=
rateDiff <- summarise(group_by(nd, CreditScoreEst, regime)
                      ,meanRate = mean(LenderYield,na.rm=TRUE)
                      , medRate = median(LenderYield,na.rm=TRUE)
                      , meanRoi = mean(roi,na.rm=TRUE)
                      , sdRate  = sd(LenderYield, na.rm=TRUE)
                      , medRoi = median(roi,na.rm=TRUE)
                      , meanInq=mean(TotalInquiries,na.rm=TRUE) 
                      ,num = length(roi)) %>% filter(num > 10)          

ggplot(rateDiff, aes(x=CreditScoreEst, y=meanRoi,size=num, color=regime))+
  geom_line() +
  theme_bw() +
  xlim(500,900) + 
  scale_y_continuous(labels=percent, limits=c(-.3,NA)) +
  labs(title='Estimated Credit Score vs. ROI',x= 'Estimated Credit Score'
       , y='Mean ROI',color='Regime',size='Loans Originated')
#Total Inquiries, other hard credit variables, could be useful to better proxy for borrower creditworthiness.
@
Figure \ref{fig:roivscore} shows that lower credit score loans earn lower
average returns in the early auction regime, inconsistent with the EMH prediction of a risk/reward tradeoff.
The expected pattern is shown in the two later regimes' curves: riskier loans earn higher average returns. Figure \ref{fig:roivscore} also reveals early auction regime returns are worse than the other two regimes' returns for each bucket, but that the gap is much greater for riskier loans. Again, time period may be a confounding factor, as riskier investments often perform worse in bad economic times, a possibility I discuss later.
We now examine default rates and interest rates, the two features that explain
the variation in returns.

\subsection{Interest Rates and Defaults Across regimes}
<<ratevtime,cache=FALSE,fig.height=3, fig.cap="The blurred lines show the median interest rate of loans originated each month. The solid lines represent the median rate for loans to borrowers in the 640-660 credit score bucket for each month. The size of each line represents the number of loans originated in the appropriate month. The color of the line represents the regime. Loans funded after the shutdown are associated with higher rates after controlling for borrower credit score bucket.">>=
ggplot() +
  geom_line(aes(x=mmeans$mgroup, y=mmeans$mRate, size=mmeans$numLoans, color=mmeans$regime),alpha=.5) + 
  geom_line(aes(x=mm3$mgroup, y=mm3$mRate, size=mm3$numLoans, color=mm3$regime)) + 
  theme_bw() +
  labs(title='Interest Rates Over Time', color='Regime',size='Loans Originated',x='Origination Month',y='Mean Rate')+
  scale_y_continuous(label=percent, limits=c(.1, .33))
@

Figure \ref{fig:ratevtime} presents the median interest rate\footnote{Before
Fees.} for each month of the sample. The solid line again represents borrowers
in the 640-660 credit score bucket, while the blurred line represents all
borrowers. Overall (blurred line), the median interest rate paid by borrowers
increases from 17.4\%  to 19.6\% to 22.5\% over the early auction, late auction
and Prosper-rate regimes. When we control for borrower selection by only
considering the 640-660 credit score bucket, however, the climb in median
interest rate (from 17.1\%  in the early auction period to 26.4\% in the late
auction period) is more dramatic. Interestingly, rates for the 640-660 bucket are almost identical directly before and right after the shutdown but the upwards trend, from from 15\% at the beginning of 2007 to 30\% at the end of 2010 is clear.

<<ratevscore, cache=FALSE, fig.cap='This chart shows the median interest rate borrowers from each credit score bucket paid during each period. Under the early auction regime, interest rates were lower, especially for risky borrowers, and lenders were less sensitive to risk.',fig.height=6>>=
ggplot(rateDiff, aes(x=CreditScoreEst, y=medRate, color=regime)) +
  geom_line(size=3)+
  geom_vline(xintercept=600, linetype=2)+
  theme_bw() + 
  xlim(449,NA) +
  labs(title='Credit Score vs. Interest Rate by Regime', x='Credit Score Bucket', y='Median Interest Rate', color='Regime') +
  scale_y_continuous(labels=percent) +
   scale_fill_continuous(guide = guide_legend()) +
    theme(legend.position="bottom")
@
Figure \ref{fig:ratevscore} shows that majority of the difference in interest rates between regimes can be attributed to the rates paid by borrowers in risky credit buckets, with credit scores in the 620-700 range. Investors across regimes demand similar interest rates from low-risk (high credit) borrowers. For the 760-780 bucket, early auction regime investors charged  9.0\%, late auction regime investors charged 9.4\%. However, for higher risk buckets, the prices are extremely different; for the 640-660 bucket, early auction regime investors charged 16.0\%, while late auction investors charged 26.3\%. 

More generally, the slope of the curves in Figure \ref{fig:ratevscore} show that
late auction regime investors were much more sensitive to changes in borrower
credit score than early auction regime investors were. In the early auction
regime, a 100 point increase in credit score was associated with a 4\% reduction
in interest rate.\footnote{This analysis uses regressions that predict Interest
rate, not the chart itself. The regressions can be found in the appendix.} In the late auction regime, a 100 point increase in 
credit score is associated with an 11\% reduction. In the Prosper-rate regime,
a 100 point increase in credit score is associated with a 10\% reduction in interest rate.

Freedman and Jin find that early auction regime borrowers ``understand ordinal
difference across credit buckets.'' It appears, however, that investors were
almost completely insensitive to changes in credit score below the 600-620
buckets. In fact, any sensitivity they might have shown was in the wrong
direction: for early regime auction borrowers in credit buckets below 600, the
correlation between credit score and interest rate is .097, meaning borrowers
with higher credit scores paid higher interest rates. This pattern cannot be
dismissed as an artifact of small sample size, the 6,504 loans to borrowers in
these buckets account for 23\% of early auction regime loans. Early auction
regime investors' insensitivity to credit scores among risky
borrowers can be understood in the context of Iyer et. al (2009)'s finding that
investors relied more heavily on ``soft'' information when evaluating borrowers
with low credit scores.\footnote{Zhang and Liu (2012) also find more herding in
this population of borrowers. \footcite{zhang}}
<<defvscore,fig.height=3,cache=FALSE, fig.cap='This chart shows the default rate of the borrowers in each credit score bucket. Controlling for credit score bucket, early regime borrowers were more likely to default.'>>=
d2 =  group_by(nd,regime,CreditScoreEst) %>% 
  summarise(dr = mean(defaulted), d4=sum(defaulted*roi)/sum(defaulted),  num=length(mgroup))

ggplot(d2, aes(CreditScoreEst,dr,color=regime))+
  geom_line(size=3) +
  geom_vline(xintercept=600,linetype=2) +
  xlim(460,NA) +
  scale_y_continuous(label=percent,limits=c(0,.8)) +
  theme_bw() +
  #scale_x_continuous(label=percent) +
  labs(title='Credit Score vs. Default Rate',x='Credit Score Bucket',y='Default Rate',color='Regime')
@

<<defscore.tab,cache=FALSE>>=
a1 = filter(d2, regime=='Auction-Early')[c('CreditScoreEst','dr')]
colnames(a1) = c('CreditScoreEst','Auction-Early')
a2 = filter(d2, regime=='Auction-Late')[c('CreditScoreEst','dr')]
colnames(a2) = c('CreditScoreEst','Auction-Late')
a3 = filter(d2, regime=='Prosper-rate')[c('CreditScoreEst','dr')]
colnames(a3) = c('CreditScoreEst','Prosper-rate')
ds.tab = left_join(a1, inner_join(a2,a3, by='CreditScoreEst'), by='CreditScoreEst') %>% filter(CreditScoreEst > 600 & CreditScoreEst < 880)
colnames(ds.tab)[1] = 'Credit Score Bucket'
xtable(ds.tab, label='ds.tab', caption='Default rates for borrowers in each credit score for each regime. Credit score buckets are denoted by their midpoint. EG, the 600-619 bucket is in the first row, 609.5. Each column then represents the default rates borrowers in the (column name) regime, in the (row-name) credit bucket. Default rates are much higher for the early auction regime, especially among risky borrowers. This data underlies the previous figure. Early auction regime borrowers in buckets below 500 have even higher default rates.')
@
Lower sensitivity to credit scores, and total disregard for differences in
credit score below 600 did not work out well for early auction regime investors.
The relationship between credit score and default probability was even stronger
in that regime than in the other regimes. 
Figure \ref{fig:defvscore} presents the relationship between credit score bucket
and default rate, and shows that the probability of default decreases
(increases) with higher (lower) credit score, for all three regimes.
In the early auction regime, a 100 point increase (5 buckets) in credit score is
associated with a 15\% reduction in default probability. In the late auction
regime, a 100 point increase is associated with a 7\% reduction in default
probability. In the Prosper-rate regime, an 100 point increase is associated
with a 12\% increase in default probability. The data that underly Figure \ref{fig:defvscore}
can be viewed in tabular form in Table \ref{ds.tab}.

Overall, 37.1\% of borrowers in the early auction regime defaulted, many more than the 16.2\% default rate of the late auction period. 
However, much of this effect is caused by the fact that borrowers in the late
auction regime were in higher credit buckets. Inside of each credit bucket,
where each regime has borrowers, the
difference between default rates is, on average, 10.2\%. Just as with interest
rates, however, the gap between the early and late auction regime default rates is wider
for risky borrowers.\footnote{For borrowers in the 640-660, 740-760 and 840-860 buckets default rates were
13\%, 9\% and 2\% higher, respectively, in the early auction regime than in the late auction
regime.}

For credit buckets above 600, the relationship between credit score and default rate appears to be fairly linear, for all three regimes, suggesting that borrowers should be sensitive to credit scores when setting interest rates, since they are predictive of default. 
Early auction regime investors, then, were not sufficiently sensitive to the
hard credit variables that are predictive of default, especially when evaluating
risky, low-credit borrowers, suggesting that the poor returns of the early
auction regime were not caused exclusively by the time period, but also by poor investor decisions. We now look at the more informative grading algorithm Prosper began using after the shutdown, which made investors more sensitive to hard credit variables.

\subsubsection {More Informative Grading, Higher Interest Rates}
<<csmix2, cache=FALSE, fig.height=9, fig.cap='Another way to visualize the credit scores of borrowers in each grade. Dotted Lines indicate mean credit bucket for each grade. Each (row,column) entry is the distribution of borrower credit scores that were assigned grade (column) during the (row) regime.',fig.height=5>>=
nd$g2 = factor(nd$grade, levels= c("AA","A","B","C","D","E","HR"))
gbf = filter(nd, grade != 'NC' & Date < dis1) %>% filter(grade != '') %>% group_by(g2,regime)

means  = summarise(gbf, val = mean(CreditScoreEst,na.rm = TRUE)
                   ,num = length(CreditScoreEst))

ggplot(ungroup(gbf), aes(x=CreditScoreEst,fill=g2)) + 
  geom_histogram(aes(y=..count..))+
  facet_grid(regime~g2,scales='free_y') +
  xlim(400,900)+ theme_bw()+
  geom_vline(data=means, aes(xintercept=val,color=g2), linetype=2) +
  labs(title='Credit Grade Assignments by Regime.',
       x ='Credit Score Bucket',y='Count',fill='Credit Grade') +
    scale_x_continuous(breaks=seq(from=600,to=800,by=200),limits=c(500,900))
@
In Figure \ref{fig:csmix2}, each $(row,column)$ entry is the distribution of borrower credit scores that were assigned grade $column$ during the $row$ regime. For example the top row, left most entry presents the credit score buckets of the borrowers who were assigned grade AA in the early auction regime. In the early auction regime, all borrowers in a given credit bucket were assigned the same grade. Since all borrowers in the 640-680 buckets were assigned grade C, we can see two adjacent spikes, one for the 640-660 bucket, and another for the 660-680 bucket, in the top row of the grade C column of Figure \ref{fig:csmix2}. No other credit grades in the top row have any borrowers from the 640-680 buckets.

In the late auction regime, Prosper began using multiple variables to form its credit grade, and borrowers in each credit score bucket are spread across grades based on other credit variables. Correspondingly, in the bottom row of the grade C column of Figure \ref{fig:csmix2}, we can see that late auction regime, grade C borrowers came from 11 different credit buckets.
When Prosper began aggregating hard credit variables into more informative grades, investors began relying heavily on these grades when determining interest rates.
<<ratepred,cache=FALSE>>=
func2 <- function(LenderYield,CreditScoreEst,TotalInquiries,CurrentDelinquencies,grade){
  tmp = data.frame(cbind(LenderYield,CreditScoreEst,TotalInquiries,CurrentDelinquencies,factor(grade)))
  rateReg  = mlm(LenderYield ~ CreditScoreEst + CurrentDelinquencies + grade + TotalInquiries, data=tmp)
  return(rateReg$adj.r.squared)
}
func3 <- function(LenderYield,CreditScoreEst,TotalInquiries,CurrentDelinquencies,grade){
  tmp = data.frame(cbind(LenderYield,CreditScoreEst,TotalInquiries,CurrentDelinquencies,factor(grade)))
  rateReg  = mlm(LenderYield ~ CreditScoreEst, data=tmp)
  return(rateReg$adj.r.squared)
}

rf = group_by(nd,regime) %>% 
  summarise(fit = func2(LenderYield,CreditScoreEst,TotalInquiries,CurrentDelinquencies,grade)
            ,num = length(LenderYield))
colnames(rf) = c('Regime','Fit','Number of Loans')
xtable(rf, label='ratefit',caption= 'This table documents how much of the variance in interest rates in each of the three regimes can be explained by variance in hard credit variables, including grades. \'Fit\' is measured as the Adjusted $R^{2}$ of a regression with interest rate as the dependent variable and standard credit variables as independent variables, using every loan in the relevant regime.')

rf2 = group_by(nd,regime) %>% 
  summarise(fit = func3(LenderYield,CreditScoreEst,TotalInquiries,CurrentDelinquencies,grade)
            ,num = length(LenderYield))
colnames(rf2) = c('Regime','Fit','Number of Loans')
xtable(rf2, label='ratefit2',caption= 'This table documents how much of the variance in interest rates can be explained by borrowers\' credit score buckets. \'Fit\' is measured as the Adjusted $R^{2}$ with interest rate as the dependent variable and credit score bucket as the independent variable, using every loan in the relevant regime.')
@
The tension between the importance of the credit score in the credit grade and the importance of the credit score in the interest rate is resolved by the fact that credit grades are much more predictive of interest rates in the later two regimes. In Table \ref{ratefit}, the \emph{Fit} column shows the fraction of the variance in interest rate that can be described by variance in hard credit variables, as measured by the adjusted $R^{2}$ of a regression with interest rate as the dependent variable and credit score bucket, current delinquencies and credit grade as independent variables. This regression yields adjusted $R^{2}$ of 49\%, 88\% and 97\% for the early auction, late auction and Prosper-rate regimes, respectively, suggesting that Prosper's more informative grades are immediately used by borrowers to determine interest rates.\footnote{The full regression results are available in the appendix.}

Since we do not know Propser's exact grading formula, it may include information
that was not previously available to borrowers. Table \ref{ratefit2} addresses
this concern by running the same procedure as used for Table \ref{ratefit}, but
with credit score bucket as the only independent variable. The direction of the
results is the same: Prosper's change to more informative grading did not only
lead to a larger role for those grades in investors' interest rates, but
increased the weight of credit score bucket, a variable that investors had
access to in the same format in both periods. The difference between the early and late auction regimes' Fit is much larger in Table \ref{ratefit} than in Table \ref{ratefit2}, which suggests that part of the increased predictability of interest rates in the Late Auction regime comes from hard credit variables besides the credit score bucket. We cannot determine whether these hard credit variables were included in the grade.

If the crowd of investors were as wise as Hayek hopes, Prosper's repackaging of multiple variables into a more informative credit grade should not affect the weight of a single variable like credit score in investors' risk estimates. Furthermore, Figure \ref{fig:defvscore} makes it clear that investors would have experienced fewer defaults, and thus earned higher returns, if they had used credit buckets more heavily in their risk assessments, given the poor returns associated with low credit borrowers. We can thus attribute some of the poor returns of the early auction regime to a lower level of reliance on hard information. 

In the next sub section, I estimate the impact of Prosper's other interventions, which ban low-credit borrowers.
\subsection{Impact of Subprime Borrower Ban}
<<csvtime,cache=FALSE,fig.height=3, fig.cap="This figure presents average estimated credit score of loans originated each month. The size of each dot represents the number of loans originated each month. The average credit score (using bucket midpoint) increases from 653 in the early auction regime to 714 in the late auction regime, before returning to 705 in the Prosper-rate regime. Grey clouds indicate one standard deviation.">>=
ggplot(mmeans, aes(x=mgroup, y=mcs, color=regime)) +
  geom_point(aes(size=numLoans))+
  geom_smooth(aes(ymax=mcs.up, ymin=mcs.down),stat='identity') +
  geom_line() +
  theme_bw() +
  labs(title='Borrower Credit Scores Over Time', size='Loans Originated',x='Origination Month', y='Mean Borrower Credit Score')
@
We now turn to Prosper's policy changes, which restrict the types of borrowers who investors are allowed to lend to. An auction perspective predicts that the crowd of lenders should be able to effectively screen all candidates, not just low risk candidates. On multiple occasions, however, Prosper has intervened to restrict the borrower pool to high credit borrowers, and thereby improved investor returns. Figure \ref{fig:csvtime} shows the mean borrower credit score for each month in the sample, with the grey clouds showing one standard deviation bounds. Overall, for the three samples in full, the average borrower credit scores increases from 653.2 before the shutdown to 714.2 after the shutdown, then dips to 705 for the Prosper-rate period.
For the first 10 months of Prosper's history, investors choose to lend to borrowers with an average estimated credit score of 609. Prosper's policy change, on March 1, 2007, that prevented loans to ``low-credit borrowers," defined as those with credit score below 520, showed an immediate positive impact on investor decision making and returns.

Prosper's reasoning for the change was to protect investors: by March 1, 2007,
14.9\% of loans to low-credit borrowers had already defaulted, more than triple
the 4.6\% of loans to other borrowers that had already defaulted. \footnote{The
10\% gap in default rates is even more striking when the average age of the two
groups of loans is considered. On March 1, 2007, the loans to low-credit
borrowers averaged 100 days since origination, while loans to other borrowers
averaged 122 days since origination. 14.9\% of low credit borrowers defaulted
over an average time since origination of 100 days, whereas only 4.6\% of other
borrowers defaulted over an average time since origination of 122 days.}
Theoretically, however, it is more difficult to understand why Prosper needed to
step in. From the EMH perspective, investors would have reacted to the news of
the defaults on low credit loans by decreasing their exposure to low credit
loans, or increasing the interest rates they bid on them. However, the median
interest rate on low-credit, actually decreased from 24.23\% for the month of
July, 2006 to 23.4\% for February, 2007, the month before the intervention.
Similarly, exposure to low credit loans did not substantially decrease. On
December 1, 2006, 13.3\% of these bad loans had already, after an average of
only 3 monthly payments, gone into default, as compared to 3.7\% of other loans.
Yet over the month of December 2006, loans to borrowers with credit score below
520 accounted for 22\% of originations, the highest proportion in the site's history.  Hayek's wisdom of the crowd theory expects market participants to adjust their beliefs to new information more rapidly and flexibly than Prosper. The data, however, show that investors continued to make avoidably bad decisions until Prosper disallowed them. 

After the intervention, returns improved substantially. For the loans originated in February 2007, the month before the change, the mean borrower credit score was 620, with standard deviation 117, while the mean ROI on a loan was -13.1\%. For loans originated in March 2007, the month after the change, the mean borrower credit score was 650, with standard deviation of 83, and mean ROI -7.4\%. The 30 point month to month increase in mean borrower credit score is the largest in the sample, and the associated ROI change is not caused by time differences: the default rate to borrowers in the 640-660 bucket, a representative example, was 42.7\% in February, and actually rose to 44.8\% in March. Had Prosper enforced this rule from the site's inception, the default rate on loans originated before the rule change would have been reduced by 6\%, and mean ROI would have increased from -9.1\% to -4\%, a savings of roughly \$2 million for investors.

A similar line of analysis can be applied to examine the impact of Prosper's second intervention. Upon re-opening after the shutdown, borrowers were required to have a credit score $\geq 640$ and returning borrowers were required to have a credit score $\geq 600$. This policy change is associated with a similar shift in average borrower credit score (measured as bucket mid-point) from 678 in October, 2008 to 701 for July, 2009. The contemporaneous decrease in default rates makes it more difficult to explain the ROI jump exclusively through changes to the borrower population. But like in the previous intervention, low-credit loans continued until they were no longer allowed. By September 2008, the last full month before the shutdown, 19.8\% of loans to borrowers in the 520-640 buckets had already defaulted, compared with 8.1\% of loans to more creditworthy borrowers, yet 32\% of originated loans for that month were to borrowers in the 520-640 range. August, 2009, the first full month after the rule change, only 7.5\% of loans were to borrowers in that range, all of whom had borrowed with Prosper before. To reiterate, even with access to public information that showed that their lending strategies were not profitable, investors did not adjust. In the next section, we show that this lack of adjustment allows for the possibility of using public information to earn excess returns during the early auction period.

\section{Excess Returns}
\subsection{Puzzle: Bad Returns in Early Auction regime}
Although Figure \ref{fig:ratevscore} shows that investors charge higher rates to
riskier borrowers, it also shows that early auction regime investors were
insensitive to differences between low-credit borrowers, and, more generally,
less sensitive to credit score than borrowers in subsequent regimes. 
The high risk, low-reward data pattern of the early auction regime, shown in
Figures \ref{fig:roivscore} and \ref{fig:defvscore} show that this sensitivity to credit
score was far too low, and does not come close to making up for the difference
in default likelihood. These claims, however, are both vulnerable to the
critique of an unlucky time period. In this section, I present this essay's key
test of market efficiency: can a simple loan selection strategy earn excess
returns using publicly available information?

The answer is simple, but powerful: when investors set interest rates by
auction, in the early auction and late auction regimes, it is possible to earn
excess returns. Once Prosper starts setting rates, my methodology is no longer
able to earn excess returns.

The rest of this section discusses the methods used to create such a strategy,
and the results of the strategy. In the methodology sub-section, I define
publicly available information as 'the information that would have been
available at origination date, the day a given loan was originated,' and discuss
the the principal challenge with complying with this definition: 
\begin{quote}
On origination day, Investors only know which loans have \emph{already}
defaulted. Many loans will end up defaulting later, but to investors, they appear
to be performing well.
\end{quote}

This insight creates four major challenges. First, we must create a variable, for
each loan, that indicates whether the loan had already defaulted on Origination
date, and use that as the dependent variable in a regression, rather than using
the natural defaulted or ROI variables used in section 4. Second, we must fix a
\emph{cut date} at which we use all publicly available information to train a
linear model, and then use this model to select from the pool of loans that have
not been originated.\footnote{This approach also carries the standard
cross-validation benefit, by penalizing overfitting.} Thirdly and most subtly, an investor would not have known
which variables would be useful predictors of future loan performance, only
which variables had been past predictors of loan performance. For this reason, I do not
choose the independent variables used by the linear model, an automated feature
selection procedure makes this decision. Finally, during some month after the
\emph{cut date} investors did not know whether the listings in the future would
be more profitable than the listings in the present, so the strategy must choose
10\% of the loans offered in a given month in each credit grade, rather than
considering the full pool of loans and picking the best 10\%.\footnote{The
credit grade constraint is to ensure that the models do not use our hindsight
knowledge that certain credit grades performed poorly to improve performance.}

The methodology sub-section which follows further explores the nature of
these challenges, the implementation of the solutions, and new challenges
created by the solutions.
The section then continues with In Sample results, which show that the independent
variables chosen by the feature selection protocol are very similar to the
variables Prosper subsequently used to make its more informative grading, and that
mispricings were most predictable in the early auction regime. The section
concludes with Out-of-Sample results, which show that such a strategy can earn
excess out-of-sample returns in the early auction and late auction regimes, when
investors set interest rates, but fails to earn excess returns in the
Prosper-rate regime, when Prosper sets interest rates directly.
\subsection{Methodology}
\subsubsection{Cross Validation Procedure}
<<crossValexp, cache=FALSE>>=
cval = data.frame('Sample'= c('Auction-Early.train', 'Auction-Early.test','Auction-Late-.train','Auction-Late.test',
                             'Prosper-rate.train','Prosper-rate.test'),
                 'Loans'= c(nrow(train),nrow(test),nrow(tr2),nrow(te2),nrow(tr3),nrow(te3)),
                 'Start' =  c(min(train$Date),min(test$Date),min(tr2$Date),min(te2$Date),min(tr3$Date),min(te3$Date)),
                 'End' =  c(max(train$Date),max(test$Date),max(tr2$Date),max(te2$Date),max(tr3$Date),max(te3$Date))) %>%
  transform(Days = as.character(as.numeric(difftime(End, Start))), Start = as.character(Start), End=as.character(End))
xtable(cval, label='cval', caption='This table documents number of loans and dates of the 6 samples used for training and testing regression strategies.')
@
Regime changes split the data into early auction, late auction and Prosper-rate regimes. To test our predictions out of sample, we split each of these thirds in half. For those familiar with cross validation, regressions are trained on the first half of loans originated under each regime, and tested on the second half. Table \ref{cval} describes the size and periods of the six sub samples. For those less familiar with cross validation, I now describe the six sub samples in detail.
\begin{enumerate}
\item \Sexpr{nrow(train)} loans originated between April 21, 2006 and  October 2nd, 2007, are used to generate coefficients for the early auction regime regressions.
\item \Sexpr{nrow(test)} loans originated after October 2nd, 2007, but before October 16, 2008, are used to test  the predictions of the early auction regime regressions. \footnote{Between October 10, 2008 and July 20, 2009, no loans are originated, because Prosper is in the SEC-imposed Quiet Period}
\item \Sexpr{nrow(tr2)} loans originated between July 20, 2009 and  April 26, 2010, are used to generate coefficients for the late auction regime regressions. 
\item \Sexpr{nrow(te2)} loans originated after April 26, 2010, but before December 17, 2010, are used to test the predictions of the late auction regime regressions.
\item \Sexpr{nrow(tr3)} loans originated between Dec 20,2010 and April 28,2011  are used to generate coefficients for the Prosper-rate regime regressions.
\item \Sexpr{nrow(te3)} loans originated between April 29,2010 and August 3rd 2011 are used to generate coefficients for the Prosper-rate regime regressions.
\end{enumerate}

\subsubsection{Avoiding Look-ahead Bias with Known-Default}
Unfortunately, since our time series is so short, the challenge of training models on the limited information a lender would have is considerable; the early Auction regime starts in April 2006, and ends in October 2008, and all loans last 36 months, so in October 2007, an investor only knows 18 months of payment results of the earliest origination. To address this challenge, we develop a binary Known-Default variable. For a given loan, Known-Default equals 1 if the ex-post sum of the payments of a loan is less than the percentage of 36 months that had elapsed by the end of the training period.

As an illustrative example, suppose Bill borrows \$100 in April 2006, and that the training period ends December 2007.
If Bill ends up paying back \$60 to investors over the full 36 months, his Known-default = 0 (even though he ended up defaulting) because the training period ends after 55.6\% of his three years have elapsed, but he paid back 60\% of his loan. If, however, Bill only ends up paying back \$50 to investors, Known Default=1, because Bill MUST have already missed at least one payment by the end of the training period.

Using Known-Default \footnote{It would be difficult to create known-ROI because there is no data on the magnitude of each monthly payment}  as our left hand side variable instead of observed defaults or ROI allows us to restrict the information available to models to the same set of information that investors had at their disposal at the end of the training period, namely borrower characteristics of each loan that has already been originated, and whether it has \emph{already} gone into default. One downside of this approach is that for each period, many loans were originated in the month before the end of the training period, and almost none of these investors miss their first monthly payment. To avoid these young loans, about whose performance almost nothing is known, from exerting a large impact on the model's coefficients, I weight observations by \textit{observation maturity}, the amount of time that has elapsed between a loan's origination and the end of the training period, in a weighted linear regression, using the training sample data.


\subsubsection{Feature Selection}
The following procedure is executed on the training data for each of the three regimes to determine the 8 features\footnote{I use the terms 'feature' and 'Independent Variable' interchangeably.} to use in the regression. An automated\footcite{leaps} feature selection prevents me from being able to add variables to the regression that I know to be powerful, a subtler form of look-ahead bias.
\begin{enumerate}
\item Start with 45 features, chosen by me because they don't have missing data.\footnote{A complete list of features can be found on \url{github.com/sshleifer/ProsperThesis}}.
\item Scale the features to have 0 mean and unit variance, by subtracting the mean from each observation and then dividing by the standard deviation.
\item For each possible 8-feature subset of the original features, run a linear regression predicting Known-Default, and recover the Bayesian Information Criterion.\footnote{For more on BIC, \url{http://en.wikipedia.org/wiki/Bayesian_information_criterion}}
\item Choose the subset of features with the highest BIC. These 8 features are then used in the training regressions.
\end{enumerate}

\subsubsection{Out of Sample Loan Selection}
After training linear models to predict Known-Default, we use the coefficients to predict known-default as a proxy for real default, for each possible loan in the testing sample, and choose the 10\% of loans from each credit grade with the lowest predicted default likelihood. \footnote{Loans are selected from each credit grade to ensure that strategies in the later periods can actually earn positive returns. Grade A loans in later periods return less than average.}
\subsubsection{Summary of Procedure}
For each regime \ldots
\begin{enumerate}
\item Divide the loans into training and testing samples of equal size, with all loans in the training sample originated before the first loan in the test sample was originated.
\item Avoiding Look-ahead Bias: create variable Known-Default $= (0 || 1)$ for
  each loan, depending on whether a loan had \textbf{already} defaulted at the end of the training sample.
\item Feature Selection: start with 45 Features, select the 8 feature subset that best predicts Known-default.\footcite{leaps}
\item Cross-Validation Part 1: Run Linear Regression to predict Known-Default using training period data and selected variables.
\item Cross-Validation Part 2: Using trained coefficients, generate predicted Known-Default values for loans in the test period.
\item Cross-Validation Part 3: Select the 10\% of Loans from each credit grade with the lowest predicted Known-default probability.
\item Measurement of Returns: Compare ROI of selected loans against the  benchmark of a strategy that chooses every loan.
\end{enumerate}
\subsubsection{Assumptions}
Two assumptions underly the out-of sample loan selection technique which selects
from the pool of loans that were funded by Prosper's investors, at the rate they
received. First, in the auction regime, by sucessfully bidding on a loan,
investors may decrease the interest rate. This analysis assumes that a strategy
does not move the interest rates of the loans it selects. Second, a strategy
never chooses to fund loans that will end up unfunded, since we cannot observe
their ROIs.
\subsection{In Sample Results}
<<runRegs,cache=FALSE>>=
form1.sc = makeForm(bigReg1.sc,'def ~')
form2.sc = makeForm(bigReg2.sc,'def ~')
form3.sc = makeForm(bigReg3.sc,'def ~')

log1.sc <- glm(form1.sc, data=train,family=binomial,weights=maturity)
lm1.sc <- lm(form1.sc, data=train, weights=maturity)

log2.sc <- glm(form2.sc, data=tr2,family=binomial,weights=maturity)
lm2.sc <- lm(form2.sc, data=tr2,weights=maturity)

log3.sc <- glm(form3.sc, data=tr3,family=binomial,weights=maturity)
lm3.sc <- lm(form3.sc, data=tr3,weights=maturity)

texreg(list(lm1.sc,lm2.sc,lm3.sc),custom.note='Y = Known-Default', label="KDLinear",
       ,custom.model.names = c('Auction-Early','Auction-Late','Prosper-rate')
       , caption='Coefficients extracted from Least Squares Regression to predict Known-Default in early auction, late auction, and Prosper-rate regime training data.', digits=4, bold=.05)
@
The Linear Regression results shown in Table \ref{KDLinear} suggest that returns are much more predictable before the shutdown than after: the Adjusted $R^{2}$ for each regime's regression fall from \Sexpr{summary(lm1.sc)$adj.r.squared *100}\% for the early auction regime to
\Sexpr{round(summary(lm2.sc)$adj.r.squared *100, 2)}\% for the late auction regime and 
\Sexpr{round(summary(lm3.sc)$adj.r.squared *100,2)}\% for the prosper rate regime. 
The coefficients for all regressions are so close to zero because we are predicting Known-Default, which occurred in 11\% of Auction Regime, training sample observations, but only 1.5\% in the late auction regime training data and 1.0\% of observations in the Prosper-rate regime data. The discrepancy in Known-default rates is caused by both a shorter period of training data and a lower actual default rate for the later regimes.

More interestingly, we can see that for the early auction regime, the automated feature selection procedure chosen many of the same variables, like Inquiries, Credit Score and Delinquencies, that were used by Prosper to determine its more informative grades, which had the effect of guiding lenders towards setting higher interest rates.

The finding that the features selected to predict superior returns
through my purely mechanical procedure end up being very similar to the features
subsequently used by Prosper to set credit grades supports the view
that investors failed to attend to these variables,
and that Prosper as a market maker fixed their errors. Prosper's subsequent
reliance on the information I use to beat the market, supports the argument that
the information was, in fact valuable, while the facts of Section 4, namely
Figure \ref{fig:ratevscore}, aim to show
that the information was largely ignored. Even more importantly, this analysis is NOT
vulnerable to the critique that my tests of market efficiency are undermined by
an unlucky time period. In particular, Prosper used these same variables to
guide investors, and improve market efficiency, at a very different time.
<<os.funcs,results='hide',cache=FALSE>>=
os.ts.test<-function(reg,df, fg=10,str,cs=FALSE){
  gb = if(cs) gb=group_by(df,mgroup,grade) else group_by(df,mgroup)
  models <- gb %>% do(lns =  as.numeric(regTest(reg,., fg))) 
  if (cs) mgroup = models[,c('mgroup','grade')] else mgroup = models$mgroup
  result = cbind(mgroup,summarise_each(models, funs(meanUL,length,sdUL),lns))
  result$model = str
  return(result)
}
os.vec.test<-function(reg,df, fg=10,str,cs=FALSE){
  gb = if(cs) gb=group_by(df,mgroup,grade) else group_by(df,mgroup)
  models <- gb %>% do(lns =  as.numeric(regTest(reg,., fg))) 
  return(unlist(models$lns))
}
  
#os.rls test in draft3.Rnw
os.base.test<-function(df,str,cs=FALSE){
  gb = if(cs) gb=group_by(df,mgroup,grade) else group_by(df,mgroup)
  result = summarise(gb, meanUL = mean(roi,na.rm=TRUE), length =length(roi), sdUL =sd(roi,na.rm=TRUE))
  result$model = str
  return(result)
}
@
<<os.prep,results='hide',cache=FALSE>>=
gr = TRUE
res = rbind(os.ts.test(lm1.sc,test,1,'Regression',gr)
,os.base.test(test,'Benchmark',gr)
,os.ts.test(lm2.sc,te2,1,'Regression',gr)
,os.base.test(te2,'Benchmark',gr)
,os.ts.test(lm3.sc,te3,1,'Regression',gr)
,os.base.test(te3,'Benchmark',gr))
###REG STUFFgroup_by(x,regime,model)%>% summarise(sdev = sd(mn, na.rm=TRUE))
v1 = os.vec.test(lm1.sc,test,1,'Regression',gr)
v2 = os.vec.test(lm2.sc,te2,1,'Regression',gr)
v3 =  os.vec.test(lm3.sc,te3,1,'Regression',gr)

stats = data.frame(
  'regime' = c('Auction-Early','Auction-Late','Prosper-rate')
  ,'m.roi' = c(mean(v1),mean(v2),mean(v3))
  ,'sd.roi' = c(sd(v1),sd(v2),sd(v3)))
res = if(gr) filter(res, length >0 & grade != '') else res = filter(res2, length >0)
res$regime = ifelse(res$mgroup <= dis0, 'Auction-Early',
                    ifelse(res$mgroup <= dis1, 'Auction-Late','Prosper-rate'))
hmeans  = res %>% group_by(regime,model) %>%  
  summarise(mn = sum((1+meanUL) *length) / sum(length) -1)

res.clean = res %>% group_by(mgroup,regime,model) %>% 
  summarise(roi = (sum((1+meanUL) * length) / sum(length)) -1
            , sdev=mean(sdUL), length=sum(length)) %>% transform(upper = roi+sdev, lower=roi-sdev)

@
\newpage
\subsection{Out of Sample Results}
<<retTab1,cache=FALSE,align='c'>>=
msd =group_by(res.clean,mgroup,regime,model) %>% 
  summarise(mn = mean(roi,na.rm=TRUE)) %>% 
  group_by(regime,model) %>%
  summarise(sdev = sd(mn, na.rm=TRUE))

tab = inner_join(hmeans,msd,by=c('regime','model'))
nd$t  = ifelse(nd$roi <0, 1,0)
dr1 = group_by(nd, regime)  %>% summarise(d.rate = sum(t)/length(t))
negfrac<-function(v1){return(length(v1[v1<0])/length(v1))}
dr2= data.frame(dr1, 'lm.rate'=c(negfrac(v1),negfrac(v2),negfrac(v3)),stringsAsFactors = FALSE)

fs= inner_join(filter(tab,model=='Benchmark')
                ,filter(tab,model=='Regression')
                ,by='regime')[c('regime','mn.x','sdev.x','mn.y','sdev.y')]
fs2 = inner_join(fs,dr2,by='regime')
colnames(fs2) = c('Regime','BM.mean','BM.sd','LM.mean','LM.sd','BM.def','LM.def')
fs3 = cbind(fs2[1:3],fs2[6],fs2[4:5],fs2[7])
fs3['Excess'] = fs3$LM.mean - fs3$BM.mean
xtable(fs3,label='aggstats',
       caption='This table compares the out of sample performance of the linear model (LM) strategies to the benchmark (BM). As shown in the next figure. The column names are in the format (Strategy).(statistic), where (LM) for linear model and (BM) for benchmark are the two strategies, and mean return of selected loan (mean), standard deviation of monthly returns (sd) and mean default rate of selected loans (def) are the statistics. For example, the LM.mean column shows the average ROI of a loan selected (out of sample, of course) by the linear model in each of the three regimes. The Excess column is calculated as LM.mean - BM.mean, and thus represents the difference in returns between the loans selected by the linear model and the benchmark over each regime. Notice that the Excess returns are positive for the first two regimes, where investors were involved in setting interest rates, and roughly 0 in the most recent regime, where Prosper set rates directly.', digits=3)
@
<<os.chart2,fig.cap="This table presents the out of sample returns for the loans chosen by the linear model (blue) and all loans (red) for each month in the three testing periods. The linear model, uses only publicly available information to select loans, and is described in detail in the methodology section. Horizontal lines indicate each strategy's mean return.",fig.width=10,fig.height=8>>=
ggplot(res.clean, aes(x=mgroup,y=roi,color=model)) +
  #geom_line(aes(size=length)) + 
  geom_line(size=2)+
  theme_bw() +
  geom_hline(data = hmeans, aes(yintercept=mn,color=model), linetype='longdash') +
  labs(x='Month', y='ROI', color='Model',title='Out of Sample Performance') +
  scale_x_date(labels=date_format('%b-%y')) + 
  theme(legend.position='bottom')+
  facet_wrap(~regime, scales='free_x')+
  scale_y_continuous(label=percent,limits=c(NA,NA),breaks=seq(from=-1, by=.05))
@
Table \ref{aggstats} shows the mean and standard deviation of the returns of the loans selected by the regression strategy.
For the early auction regime, when investors focused less on hard variables, set
low rates, and after observing high default rates among similar borrowers, the
model beats the benchmark by 3\%, with similar variance\footnote{Variance is
calculated as the standard deviation of monthly returns}. Moreover, a T test
comparing the 1434 loans selected by the early auction regime model and the
13,923 loans it could have selected, rejects the null hypothesis that the two
groups have the same mean ROI at the .1\% significance level. This finding is
inconsistent with the EMH prediction that it should be impossible to earn excess
returns using publicly available information. As discussed in the methodology
section, the model is trained on the observed defaults in the training sample,
and chooses the loans its predicts to have the lowest probability of default. As
such it ends up minimizing the riskiness of loans it selects, rather than trying
to optimize a risk reward calculation. Early auction period loans selected by
the model have a default rate of 21\% , compared to the 32\% default rate for
all loans.  Figure \ref{fig:os.chart2}, which compares the various strategies
out-of-sample performance over time, reveals that most of the model's outperformance is during the initial 6 months of testing.

For the late auction regime, when investors largely used the ratings prosper gave them to form interest rates, the model beats the benchmark by 5.8\%, with a slightly higher standard deviation.  A T test comparing the 360 loans selected by the late auction regime model and the sample of 3569 loans it chose from rejects the hypothesis that the two groups have the same mean ROI at the 1\% significance level. It is again clear that the superior returns of the loans chosen by the model were generated by a lower default rate: 7.8\% compared to 13.0\% for the full basket of loans. This result should interpreted carefully, however, given the noticeably higher variance and small number of selected loans. 

For the Prosper-rate regime, when Prosper set interest rates, the model is unable to beat the benchmark: it chooses loans with worse ROI, higher default rate and identical returns. 

In summary, over the initial two regimes where investors were involved in the
process of setting interest rates, via auction, it was possible to use publicly
available information to earn excess returns. \footnote{Note that excess returns
are as compared to other Prosper loans, not treasuries or another asset class.} In the final regime, where the market maker sets the interest rate,
it is much more difficult, if not impossible, to earn excess returns using
publicly available information. This likely happens because the variables
that investors neglected in the first two regimes, which we use to earn superior
returns, and the variables that Prosper eventually uses to set interest rates are very similar.

\subsection{Methodological Expansions}
An expansion of this project could retrain the model every month with the benefit of newly observed defaults and newly originated loans, and expect performance improvements.

Engineering a known-ROI dependent variable that equals the percentage of expected repayment of principal an investor received from each borrower up to the relevant date, would allow the model to make risk-reward calculations when deciding between loans, as opposed to just choosing the least risky loans.

\section{Controlling for Time Period}
<<rateSim,  results='hide', cache=FALSE>>=
crate<-filter(rateDiff, CreditScoreEst > 600 & regime=='Auction-Late')[c('CreditScoreEst','meanRate')]
dup = left_join(o1, crate, by='CreditScoreEst')
dup$oldrate = dup$LenderYield
dup$LenderYield = dup$meanRate
dup = filter(dup,!is.na(LenderYield))
dup$roi = (dup$roi + 1) * ((1 + dup$LenderYield)/(1+ dup$oldrate)) -1
dup$regime='Auction-Early.Adj-rate'
dup = filter(dup,!is.na(roi))
k3 = c('CreditScoreEst','LenderYield','roi','TotalInquiries','regime','TotalProsperPaymentsBilled')
wfake = rbind(old[k3],dup[k3]) %>% 
  filter(CreditScoreEst > 640 | (CreditScoreEst >600 & TotalProsperPaymentsBilled>0))
decomp <- summarise(group_by(wfake, CreditScoreEst, regime)
                    ,meanRate = mean(LenderYield)
                    ,medRate = median(LenderYield)
                    ,meanRoi = mean(roi)
                    ,medRoi = median(roi)
                    ,meanInq=mean(TotalInquiries,na.rm=TRUE)
                    ,num = length(roi)) %>% 
  transform(err = ifelse(regime=='Auction-Early.Adj-rate', .02, 0))
if(FALSE){
  mm4  = filter(nd, CreditScoreEst == 649.5) %>%
    group_by(regime) %>% summarise(mdef = mean(defaulted,na.rm=TRUE)
                                   , mRoi = mean(roi, na.rm=TRUE)
                                   , mRate = mean(LenderYield, na.rm=TRUE)
                                   , numLoans=length(roi)
                                   , dollars = sum(LoanOriginalAmount) / 1000000
                                   , mInq = mean(TotalInquiries,na.rm=TRUE)) %>% filter(numLoans > 5)
  
}
@
The first two inconsistencies with EMH predictions: that early auction regime loans have negative average ROI, and that riskier early auction regime loans earn investors negative ROI, are both vulnerable to time period. Specifically, maybe the early period just happened to be bad for loan repayments. In this section, I aim to show that the decisions made by early investors, namely to lend to low credit borrowers and to demand far lower interest rates than hard variables would suggest, partly explain the difference in ROI. Thus, the question guiding this section is: \textbf{what would have happened to investor returns in the early auction regime if investors only lent to borrowers that would have qualified for loans in the late auction regime, and demanded the rates charged by investors in the late auction period?} This will help to understand whether the change in returns between the early and late auction regimes was merely a consequence of an unpredictably higher default rate.

\subsection{Methodology}
In order to estimate the hypothetical returns in an early auction regime where
investors charged late auction regime rates to borrowers who would have met the
late auction regime criteria, we must (1) reduce early auction borrowers to the
subset that would have been acceptable in the late auction regime,(2) estimate
what interest rate late auction regime investors would have charged them, and
(3) then use this estimated rate to predict a new ROI.

The first step, restricting the borrower pool, is simple. In the late auction regime, Prosper required that new borrowers  have a credit score greater than 640, and that returning borrowers have  a credit score greater than 600 in order to apply for a loan. Applying this rule reduces the number of early auction regime loans whose rate we will adjust by 40.4\%, from 27,764 to 16,545.\footnote{This may not go far enough, as late auction regime investors refused to fund many borrowers applications.}

The second step of the method involves finding the hypothetical interest rate an early auction regime borrower would have paid in the late auction regime. For simplicity, this \emph{adjusted rate} is computed by finding the median interest rate paid by late auction regime borrowers in the same credit score bucket, \textit{EG} 700-720.

To simplify the third step, predicting a hypothetical ROI given actual loan performance and
a new, adjusted interest rate, I assume that borrowers would have made the same
number of monthly payments, but that each payment would be slightly bigger,
given the new interest rate. This adjusted roi is calculated by multiplying the payments the borrower made under the old regime by the ratio of $\frac{(1 + adjusted rate)}{(1 + old rate)}$.

As an instructional example, suppose Bill is an early auction regime borrower in
the 700-719 credit score bucket.
Since Bill's credit score is above the 640 cutoff, he remains in the sample.

Under the early-auction regime, Bill borrowed \$100 from investors at a 13\% interest rate, and returned \$113, over the one year course of his loan.\footnote{Neither maturity nor principal matter, for our purposes}

In the late auction regime, the median borrower 700-720 borrower paid 23\% interest, 
so, Bill's Adjusted-Rate is 23\%.

To calculate Bill's Adjusted ROI, we multiply the monthly payments he actually
made, by the ratio of the interest rates. And then divide the result by the
principal and subtract 1. This reduces to: 
\begin{equation}
ADJ.ROI = \frac{Payments}{Amount.Borrowed} * \frac{ADJ.Rate}{Actual.Rate}
\end{equation}
\begin{equation}
ADJ.ROI= \frac{113}{100} * \frac{1.23}{1.13} - 1 = 23\%
\end{equation}

Suppose, alternatively, Bill had repaid only \$45. So Bill's actual ROI was -55\%.
In this second case, Bill's Adjusted ROI = $\frac{45}{100} * \frac{1.23}{1.13} - 1 = - 51\%$.

Notice that even when Bill defaulted, his Adjusted ROI is higher than his actual
ROI. This is because the methodology assumes that Bill makes the same number of
monthly payments after his interest rate is adjusted upwards, but that each monthly
payment is bigger.
\subsubsection{Assumptions}
Three assumptions facilitate this methodology, but also cause bias.
Most importantly, the methodology assumes that borrowers would have made the
same number of monthly payments if their interest rate were higher.
This assumption is inconsistent with the idea of cost-induced default, as
discussed by Stiglitz and Weiss (1976): forcing the borrower to pay more per month might push him over the default tipping point.\footcite{credit}
Empirical support for the theory of cost-induced default can be found in Wei and Lin (2013)'s
examination of Prosper's transition from the late auction regime to the
Prosper-rate regime, which shows that when borrowers were assigned higher
interest rates, they defaulted more frequently.\footcite{wei} With this in mind,
my adjusted ROI serves as an \textbf{upper bound} because it assumes that each
borrower makes the same number of payments, even though each payment is higher.
More realistically, we might expect Bill to make fewer payments on his loan if
he found it more difficult to afford his new interest rate.

Two other assumptions work in the other direction, however. First, we have
assumed that all applications that satisfied Prosper's minimum borrower
standards would have been funded by investors. In reality, many applications met
these criteria but were not funded, and it is likely that later regime lenders
wre more selective than early regime borrowers. Secondly, we have assumed that in our hypothetical world early auction regime borrowers would pay the same rate as late auction regime borrowers in their credit bucket. In reality, however, they would probably pay higher rates, because controlling for credit score bucket, they have worse average delinquencies, credit card utilization and other hard variables that would be used for grading. 

To summarize, the total.ROI reported using the adjusted borrower population is probably a little lower than it should be, and the total.ROI reported using adjusted interest rates is probably higher than it should be.

\subsection{Results \& Discussion}
<<adjfig, cache=FALSE, fig.cap='This chart displays the results of our rate-adjustment experiment. The blue line is the result of our rate-adjustment experiment, and displays the hypothetical ROI if late auction regime borrowers had paid early auction interest rates. The grey cloud represents a 2 percent adjustment for cost-induced default.'>>=
ggplot(decomp, aes(x=CreditScoreEst, y=meanRoi, color=regime)) +
  #geom_line(aes(x=CreditScoreEst, y=meanRoi, color=regime, size=num)) +
  geom_point(aes(size=num))+
  geom_smooth(aes(ymax=meanRoi, ymin=(meanRoi - err)),stat='identity') +
  theme_bw() +
  labs(x='Estimated Credit Score', color='Regime', y='Mean ROI',size='Number of Loans', title='Rate Adjustment Results')+
  xlim(640,900)
@
Figure \ref{fig:adjfig} documents the relationship between credit score bucket and returns for early auction regime, late auction regime, and late auction regime borrowers with adjusted rates, where the rate adjustment and subsequent ROI adjustment was computed using the \emph{upper bound} methodology described above. At low credit scores, where the difference in interest rates between the two regimes is largest, the gap in ROI is also the largest. With adjusted rates, riskier assets have higher average return than less risky assets, and average returns are positive, suggesting that part of the reason the actual data is inconsistent with the EMH predictions may be the low interest rates and exposure to subprime borrowers.


<<adjTab, cache=FALSE>>=
entry = data.frame(regime='Auction-Early',total.ROI= mean(o1$roi),stringsAsFactors = FALSE)
adj.tab = group_by(decomp,regime) %>% 
  summarise(total.ROI = sum((1 + meanRoi)*num) / sum(num) -1) %>% 
  transform(regime = ifelse(regime=='Auction-Early','Auction-Early.Adj-borrowers',as.character(regime))) %>%
  rbind(entry) %>% arrange(total.ROI)
xtable(adj.tab, caption='The aggregated results of the Rate Adjustment Experiment.', label='adj',digits=4)
@
At each credit score, an upper bound estimate of the fraction of the ROI gap that would be accounted for by adjusted interest rates can be measured as:
\begin{equation}
rate.factor = \frac{mean(adj.roi)-mean(early.roi)}{mean(late.roi)-mean(early.roi)}
\end{equation}
This \emph{rate factor}\footnote{Visually, think of rate factor as if we are walking up the plot from the red line to green line,  what percentage of the way would we make it before we encountered the blue line.} is, by construction, heavily correlated with the difference in interest rates for each regime.   At the lowest included estimated credit score, 649.5, the difference in average interest rate is 9.3\%, and that difference explains 42.1\% of the 19.2\% difference in average ROI. At the higher buckets, the difference in interest rates for borrowers in the 800-820 credit score bucket was 0.3\%, and this difference explained only 3\% (not half) of the 6\% difference in average ROI.

The aggregated returns of the regimes, as shown in Table \ref{adj}, indicate that if early auction regime borrowers had self enforced the minimum standards Prosper introduced in the second period, investor returns would have improved by at least 2.8\%. If investors had charged these borrowers the rates similar borrowers were charged in the late auction regime, returns might have improved by another 5.75\%.

These results suggest that although much of the difference in performance between regimes is due to an especially bad time period, roughly $\frac{1}{3}$ of the difference in returns between the early auction and late auction regimes can be explained by poor investor decisions.

\subsection{Comparison to Traditional Loans}
<<macro,cache-FALSE>>=
#<600 11.84
#601-660 17.84
#661-720 30.48
#Over 720 39.16
nd$year = year(nd$mgroup)
grouper<- function(x){
  return(ifelse(x < 660, .2969,
                      ifelse(x < 720, .3048,
                                    ifelse(x > 720, .3969, .2969))))
}
nd = transform(nd, cg = grouper(CreditScoreEst))
nd.ts = group_by(nd, regime, year, cg) %>% 
  summarise(def.rate = mean(defaulted), n = length(defaulted)) %>% filter(n > 103)
nd.ts= mutate(ungroup(nd.ts), year = as.numeric(year), def.part = def.rate*cg)
ts.adj = summarise(group_by(nd.ts,regime,year), def.adj = sum(def.part), n=sum((n)))

mac = read.csv('Data/comet.csv',col.names=c('year','def.rate3'))
# ts.raw = group_by(nd, regime, year) %>% 
#   summarise(def.rate = mean(defaulted), n = length(defaulted)) %>% filter(n > 300)
ts = inner_join(mac, ts.adj, by='year') %>% arrange(year) 
colnames(ts) = c('Origination','CapitalOne.default','Regime','Prosper.default','N.Prosper')
xtable(ts, label='macro', caption= 'This table documents the default rate of Prosper Loans (Prosper.Default) with the default rate in the first three years of consumer credit loans securitized by Capital One (CapitalOne.Default). Additionally, the regime and number of Prosper loans originated in each period are reported.')

xx = filter(read.csv('Data/c1fico.csv'), Credit.Score != '')
xtable(xx, label='macro.samp', caption='The Portion of borrowers from each credit score group in the Capital One data.')
@
By comparing the performance of Prosper loans originated in each period to the performance of traditional consumer credit loans originated in each period, controlling for credit score as best we can\footnote{Method: Given the default rates of some consumer loans, and a table of the frequency of a bunch of credit scores, I created the same credit score groups in the Prosper data, took each group's mean default rate, and took the weighted average default rate for each year, with the group's representation in the Capital One borrower pool, shown in Table \ref{macro.samp} as the weights. Since the Capital One loans are of different maturities, I measured the portion of defaults within three years of origination.} we can gain a better understanding of the time period. The data presented in Table \ref{macro} show that for all credit scores, default rates are higher for Prosper loans than Capital One loans, but that the difference is much larger in the early auction regime. There may again be flawed assumptions, including adverse selection of borrowers on the internet, other credit variables besides score, and the different maturities of the loans, but the data again suggest that early auction regime investors did a particularly bad job.

\section{Conclusion}
This paper examined interest rate setting and lender returns on Prosper.com. It
took advantage of three policy regimes over the course of 2006-2011. In the
first regime, investors set interest rates through a decentralized reverse
auction; in the second regime they continued to use the auction, but with
considerably more guidance from Prosper; and in the third regime Prosper set the
rates directly. I find that compared with the later two periods, interest rates
during the early auction regime were much lower and less sensitive to risk, and
that investor returns were much lower than in the later two regimes.

I further examined these findings and argued that the evidence from the early
auction regime is inconsistent with the predictions of the EMH. In particular, I
reported three findings: average returns in the early auction period are
negative, riskier loans earn lower average returns than more risky ones, and
--most importantly -- one can use loan selection strategies without look-ahead
bias to select well-performing loans in the early auction period. The third
finding is inconsistent with the most fundamental prediction of the EMH, that an
investor cannot earn superior risk-adjusted returns based on publicly available
information.

The first two findings are vulnerable to the critique that my results depend on
the particularly bad time period (2006-2008) during the early auction years. I
show that, even correcting for the time period, returns would have been poor
because interest rates were set too low and insufficiently sensitive to risk.
My third finding is more difficult to criticize based on the time period, since
it shows that investors could have done better in the same period, the second
half of the early auction regime, based on publicly available information.

I offer two critical pieces of corroborating evidence. First, when Prosper began
setting interest rates, it appears to haved use publicly available
variables to set interest rates that are very similar to those selected by my
Feature Selection algorithm totally independently, and then used to earn
superior returns by taking advantage of the fact that investors neglected them.
Second, I present some evidence that, in the early auction period, Prosper loans
performed considerably worse than Capital One loans with similar risk
characteristics. In short, all the evidence suggests that the decentralized
unguided mechanism of the early auction period did not lead to efficient
interest rates for Prosper loans.

The last finding has implications for financial economics and market design. It
suggests that contrary to Hayek's vision that the wisdom of the crowds leads to
efficient price setting, the crowds did not utilize all the public information
available to them, and made significant mistakes. Prosper learned this quite
quickly, and intervened. The market maker's guidance,
and eventually price control, likely improved returns.
The evidence cautions against the assumption of universal investor rationality,
and thus suggests that a market design that protects investors from their
errors and limited attention, either through educational guidance or even price
setting, may improve investor returns, and also benefit the market maker.

\newpage
\printbibliography
\newpage
\section{Appendix}
\subsection{Prosper's Charged-Off vs. Default Terminology}
After the shutdown, Prosper began using the term ``Charged-Off" to mean that a loan is delinquent past 120 days. We observe more defaults than charge-offs before the shutdown, but more charge-offs than defaults after, likely because of the shift in terminology. According to Prosper's website:
\begin{quote}
In general, a debt or account is considered “charged off” when it is unlikely that further payments will be received. Debts are usually charged off after they remain unpaid for a period of time (e.g., 90 to 180 days). Prosper uses the 120 days as the charge off threshold because loans that become over 120 days past due are eligible for sale to a debt buyer, and we have found that there is a steep drop-off in likelihood of further payments after 120 days of delinquency.\footcite{chargeoff}
\end{quote}
\subsection{Out of Sample Performance by Credit Grade}
<<retTab2,cache=FALSE>>=
vmeans = res %>% group_by(regime,model,grade) %>%  
  summarise(mn = sum((1+meanUL) *length) / sum(length) -1, n=sum(length))

bm = filter(vmeans, model=='Benchmark'); rm = filter(vmeans, model=='Regression')
csdiffs = inner_join(bm,rm, by=c('grade','regime')) %>% transform(delta = mn.y - mn.x)
excess = spread(csdiffs[c('regime','grade','delta')], grade,delta)
excess = cbind(excess[1],excess[3], excess[c(-1,-3)])
xtable(excess,label='excess',
       caption='The excess returns earned by each regression model on loans in each Credit grade'
       , digits=3)
@

<<os.chart3,cache=FALSE,fig.height=8,fig.width=10, fig.cap='The rois of the loans selected by Each strategy by Credit Grade and Regime. Dotted lines indicate means. For example, In the Prosper-rate (2nd) column in the D (5th) row, the green distribution represents the ROIs of all the Grade D loans selected by the Linear Model'>>=
ggplot(res, aes(x=meanUL,fill=model))  + geom_density(alpha=.7) +
  facet_grid(grade ~ regime, scales='free') + 
  theme_bw() +
  geom_vline(data = vmeans, aes(xintercept=mn,color=model)) +
  labs(x='ROI', y='Density', fill='Model',title='Out of Sample Performance')+
  scale_y_continuous()+
  scale_x_continuous(label=percent, limits = c(-.5,NA))
@
\subsection{Regressions to Predict Interest Rate}
<<rateFit2,cache=FALSE>>=
rateregs = list(lm(LenderYield ~ CreditScoreEst + CurrentDelinquencies + grade, data=o1),
             lm(LenderYield ~ CreditScoreEst + CurrentDelinquencies + grade, data=o2),
             lm(LenderYield ~ CreditScoreEst + CurrentDelinquencies + grade, data=n),
             lm(LenderYield ~ CreditScoreEst, data=o1),
             lm(LenderYield ~ CreditScoreEst, data=o2),
             lm(LenderYield ~ CreditScoreEst, data=n))
texreg(rateregs, caption='Regressions to predict interest rate. Columns (1) and (4) use Early Auction Regime data. Columns (2) and (5) use Late Auction regime data, columns (3) and (6) use Prosper-rate regime data.',label='rateregs')
@
The rate regs shown in Table \ref{rateregs} show the increasing importance of both grade and hard credit variables in the later regimes, as discussed in Table \ref{ratefit}.

<<noweights, cache=FALSE>>=
lm1.sc <- lm(form1.sc, data=train)
lm2.sc <- lm(form2.sc, data=tr2)
lm3.sc <- lm(form3.sc, data=tr3)

texreg(list(lm1.sc,lm2.sc,lm3.sc),custom.note='Y = Known-Default', label="kd2",
       ,custom.model.names = c('Auction-Early','Auction-Late','Prosper-rate')
       , caption='Coefficients extracted from Least Squares Regression to predict Known-Default in early auction, late auction, and Prosper-rate regime training data. Whereas the previous specification weights observations by maturity, this specification does not include weights, as a robustness check.',
       scalebox=.8, digits=4, bold=.05)
@
\end{document}
